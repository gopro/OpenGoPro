# pre_merge_checks.yml/Open GoPro, Version 2.0 (C) Copyright 2021 GoPro, Inc. (http://gopro.com/OpenGoPro).
# This copyright was auto-generated on Wed, Sep  1, 2021  5:05:35 PM

# This workflow will run pre-merge checks to verify a PR before it is merged:

name: Pre Merge Checks

on:
    pull_request:
        branches: [main, develop, release]

jobs:
    test_github_pages:
        timeout-minutes: 5
        runs-on: ubuntu-latest
        steps:
            - name: Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.8.0
              with:
                  access_token: ${{ github.token }}

            - name: Log in to the Container registry
              uses: docker/login-action@v1.10.0
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - uses: actions/checkout@v3

            - name: Test Jekyll Build and Check Links
              run: make tests

    ensure_synchronization:
        if: github.repository != 'gopro/OpenGoPro' &&  github.base_ref == 'release'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout source branch
              uses: actions/checkout@v3
              with:
                  ref: release
                  ssh-key: ${{ secrets.PUSH_FROM_WORKFLOW_TO_RETRIGGER }}

            - name: Verify synchronized if release
              shell: bash
              run: |
                  hash=$( git rev-parse HEAD | cut -c1-7)
                  target_hash=$(git ls-remote git@github.com:gopro/OpenGoPro U main | cut -c1-7)
                  echo "Target hash is $target_hash"
                  echo "release hash is $hash"
                  if [[ $hash == $target_hash ]]; then
                    exit 0
                  else
                    echo "release branch is not synchronized with external main"
                    exit 1
                  fi
