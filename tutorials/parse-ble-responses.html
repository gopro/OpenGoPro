<!DOCTYPE html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
--><html lang="en-US" class="no-js">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Tutorial 3: Parse BLE TLV Responses -</title>
<meta name="description" content="This document will provide a walk-through tutorial to implement the Open GoPro Interface to parse BLE Type-Length-Value (TLV) Responses.">


  <meta name="author" content="GoPro">
  
  <meta property="article:author" content="GoPro">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="">
<meta property="og:title" content="Tutorial 3: Parse BLE TLV Responses">
<meta property="og:url" content="https://gopro.github.io/OpenGoPro/tutorials/parse-ble-responses">


  <meta property="og:description" content="This document will provide a walk-through tutorial to implement the Open GoPro Interface to parse BLE Type-Length-Value (TLV) Responses.">







  <meta property="article:published_time" content="2025-05-14T12:39:49-07:00">






<link rel="canonical" href="https://gopro.github.io/OpenGoPro/tutorials/parse-ble-responses">












<!-- end _includes/seo.html -->


<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/OpenGoPro/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>


  
    <script src="/OpenGoPro/assets/js/tabs.js"></script>
  
    <script src="/OpenGoPro/assets/js/quiz.js"></script>
  
    <script src="/OpenGoPro/assets/js/accordion.js"></script>
  


    <script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script>
<script>
    // Add anchors on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function (event) {
        var manualAnchors = new AnchorJS();
        manualAnchors.options = {
            titleText: 'Permalink',
            placement: 'left'
        };
        manualAnchors.add('.anchored');
    });
</script>
<link rel="apple-touch-icon" sizes="180x180" href="/OpenGoPro/assets/images/logos/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/OpenGoPro/assets/images/logos/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/OpenGoPro/assets/images/logos/favicon-16x16.png">
<link rel="manifest" href="/OpenGoPro/assets/images/logos/site.webmanifest">
<link rel="mask-icon" href="/OpenGoPro/assets/images/logos/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/OpenGoPro/assets/images/logos/favicon.ico">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="msapplication-config" content="/assets/images/logos/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/OpenGoPro/">
          
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/OpenGoPro/">Home</a>
            </li>
<li class="masthead__menu-item">
              <a href="/OpenGoPro/ble/">BLE Spec</a>
            </li>
<li class="masthead__menu-item">
              <a href="/OpenGoPro/http">HTTP Spec</a>
            </li>
<li class="masthead__menu-item">
              <a href="/OpenGoPro/tutorials">Tutorials</a>
            </li>
<li class="masthead__menu-item">
              <a href="https://github.com/gopro/OpenGoPro/tree/main/demos">Demos</a>
            </li>
<li class="masthead__menu-item">
              <a href="/OpenGoPro/faq">FAQ</a>
            </li>
</ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/OpenGoPro/" itemprop="item"><span itemprop="name">Home</span></a>

          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/OpenGoPro/tutorials" itemprop="item"><span itemprop="name">Tutorials</span></a>
          <meta itemprop="position" content="2">
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">Tutorial 3: Parse BLE TLV Responses</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://gopro.github.io/OpenGoPro/">
        <img src="/OpenGoPro/assets/images/logos/logo_square.png" alt="GoPro" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://gopro.github.io/OpenGoPro/" itemprop="url">GoPro</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Be a <strong>hero</strong>.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">US</span>
        </li>
      

      
        
          
            <li><a href="https://www.gopro.com" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
          
        
          
            <li><a href="https://twitter.com/GoPro" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.facebook.com/gopro/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i><span class="label">Facebook</span></a></li>
          
        
          
            <li><a href="https://github.com/gopro" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.instagram.com/gopro/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i><span class="label">Instagram</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
    
      
      
      
      
    
    
      <nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox">
  <label for="ac-toc">Toggle menu</label>
  <ul class="nav__items">
    
      
      
        <li>
          
            <a href="/OpenGoPro/tutorials/connect-ble"><span class="nav__sub-title">1: Connect BLE</span></a>
          

          
        </li>
      
        <li>
          
            <a href="/OpenGoPro/tutorials/send-ble-commands"><span class="nav__sub-title">2: Send BLE Commands</span></a>
          

          
        </li>
      
        <li>
          
            <a href="/OpenGoPro/tutorials/parse-ble-responses"><span class="nav__sub-title">3: Parse BLE TLV Responses</span></a>
          

          
        </li>
      
        <li>
          
            <a href="/OpenGoPro/tutorials/ble-queries"><span class="nav__sub-title">4: BLE Queries</span></a>
          

          
        </li>
      
        <li>
          
            <a href="/OpenGoPro/tutorials/ble-protobuf"><span class="nav__sub-title">5: BLE Protobuf</span></a>
          

          
        </li>
      
        <li>
          
            <a href="/OpenGoPro/tutorials/connect-wifi"><span class="nav__sub-title">6: Connect WiFi</span></a>
          

          
        </li>
      
        <li>
          
            <a href="/OpenGoPro/tutorials/send-wifi-commands"><span class="nav__sub-title">7: Send WiFi Commands</span></a>
          

          
        </li>
      
        <li>
          
            <a href="/OpenGoPro/tutorials/camera-media-list"><span class="nav__sub-title">8: Camera Media List</span></a>
          

          
        </li>
      
        <li>
          
            <a href="/OpenGoPro/tutorials/cohn"><span class="nav__sub-title">9: Camera on the Home Network</span></a>
          

          
        </li>
      
    
  </ul>
</nav>

    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Tutorial 3: Parse BLE TLV Responses">
    <meta itemprop="description" content="This document will provide a walk-through tutorial to implementthe Open GoPro Interface to parse BLEType-Length-Value (TLV) Responses.">
    <meta itemprop="datePublished" content="2025-05-14T12:39:49-07:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://gopro.github.io/OpenGoPro/tutorials/parse-ble-responses" itemprop="url">Tutorial 3: Parse BLE TLV Responses
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          15 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
<li><a href="#requirements">Requirements</a></li>
<li><a href="#just-show-me-the-demos">Just Show me the Demo(s)!!</a></li>
<li><a href="#setup">Setup</a></li>
<li><a href="#response-overview">Response Overview</a></li>
<li>
<a href="#parsing-a-one-packet-tlv-response">Parsing a One Packet TLV Response</a><ul>
<li><a href="#responses-with-payload-length-0">Responses with Payload Length 0</a></li>
<li><a href="#responses-with-payload">Responses with Payload</a></li>
</ul>
</li>
<li>
<a href="#parsing-multiple-packet-tlv-responses">Parsing Multiple Packet TLV Responses</a><ul><li><a href="#accumulating-the-response">Accumulating the Response</a></li></ul>
</li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#good-job">Good Job!</a></li>
</ul>
            </nav>
          </aside>
        
        <p>This document will provide a walk-through tutorial to implement
the <a href="/OpenGoPro/ble/index.html">Open GoPro Interface</a> to parse BLE
<a href="https://en.wikipedia.org/wiki/Type-length-value">Type-Length-Value</a> (TLV) Responses.</p>

<div class="callout note">
<i class="fa fa-clipboard fa-2x" style="color: #3498db; margin: 0.25em;"></i><span>Besides TLV, some BLE operations instead return protobuf responses. These are not considered here and will be
discussed in a <a href="/OpenGoPro/tutorials/ble-protobuf">future tutorial</a></span>
</div>

<p>This tutorial will provide an overview of how to handle responses of both single and multiple packets lengths, then
give parsing examples for each case, and finally create <code class="language-plaintext highlighter-rouge">Response</code> and <code class="language-plaintext highlighter-rouge">TlvResponse</code> classes that will be reused in
future tutorials.</p>

<h1 id="requirements">Requirements</h1>

<p>It is assumed that the hardware and software requirements from the
<a href="/OpenGoPro/tutorials/connect-ble">connecting BLE tutorial</a>
are present and configured correctly.</p>

<div class="callout tip">
<i class="fa fa-tools fa-2x" style="color: #ebc21c; margin: 0.25em;"></i><span>It is suggested that you have first completed the
<a href="/OpenGoPro/tutorials/connect-ble#requirements">connect</a>
and <a href="/OpenGoPro/tutorials/send-ble-commands">sending commands</a> tutorials before going
through this tutorial.</span>
</div>

<h1 id="just-show-me-the-demos">Just Show me the Demo(s)!!</h1>

<div>
    <ul class="tab tab-linked" data-tab="9017d759-5adb-4241-b208-979cc61a7363">
        
            <li class="active">
                <a href="">python </a>
            </li>
        
            <li>
                <a href="">kotlin </a>
            </li>
        
        </ul>
        <ul class="tab-content" id="9017d759-5adb-4241-b208-979cc61a7363">
        
            <li class="active tab-content-container">
<p>Each of the scripts for this tutorial can be found in the Tutorial 3
<a href="https://github.com/gopro/OpenGoPro/tree/main/demos/python/tutorial/tutorial_modules/tutorial_3_parse_ble_tlv_responses/">directory</a>.</p>

<div class="callout warning">
<i class="fa fa-exclamation-triangle fa-2x" style="color: #df5142; margin: 0.25em;"></i><span>Python &gt;= 3.9 and &lt; 3.12 must be used as specified in the requirements</span>
</div>

<div class="accordion-container anchored">
    <button class="accordion">Parsing a One Packet TLV Response<i class="fa fa-chevron-down"></i></button>
    <div class="panel">
<p>You can test parsing a one packet TLV response with your camera through BLE using the following script:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>python ble_command_get_version.py
</code></pre></div></div>

<p>See the help for parameter definitions:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>python ble_command_get_version.py <span class="nt">--help</span>
<span class="go">usage: ble_command_get_version.py [-h] [-i IDENTIFIER]

Connect to a GoPro camera via BLE, then get the Open GoPro version.

optional arguments:
  -h, --help            show this help message and exit
  -i IDENTIFIER, --identifier IDENTIFIER
                        Last 4 digits of GoPro serial number, which is the last 4 digits of the
                        default camera SSID. If not used, first discovered GoPro will be connected to
</span></code></pre></div></div>

</div>
</div>

<div class="accordion-container anchored">
    <button class="accordion">Parsing Multiple Packet TLV Responses<i class="fa fa-chevron-down"></i></button>
    <div class="panel">
<p>You can test parsing multiple packet TVL responses with your camera through BLE using the following script:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>python ble_command_get_hardware_info.py
</code></pre></div></div>

<p>See the help for parameter definitions:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>python ble_command_get_hardware_info.py <span class="nt">--help</span>
<span class="go">usage: ble_command_get_hardware_info.py [-h] [-i IDENTIFIER]

Connect to a GoPro camera via BLE, then get its hardware info.

options:
  -h, --help            show this help message and exit
  -i IDENTIFIER, --identifier IDENTIFIER
                        Last 4 digits of GoPro serial number, which is the last 4 digits of
                        the default camera SSID. If not used, first discovered GoPro will be
                        connected to
</span></code></pre></div></div>

</div>
</div>

</li>
        
            <li class="tab-content-container">
<p>The Kotlin file for this tutorial can be found on
<a href="https://github.com/gopro/OpenGoPro/tree/main/demos/kotlin/tutorial/app/src/main/java/com/example/open_gopro_tutorial/tutorials/Tutorial3ParseBleTlvResponses.kt">Github</a>.</p>

<p>To perform the tutorial, run the Android Studio project, select “Tutorial 3” from the dropdown and click on “Perform.”
This requires that a GoPro is already connected via BLE, i.e. that Tutorial 1 was already run. You can
check the BLE status at the top of the app.</p>

<figure class="" style="
        display: block;
        text-align: center;
        margin: 10px auto;
    ">
    <img src="/OpenGoPro/assets/images/tutorials/kotlin/tutorial_3.png" alt="kotlin_tutorial_3" style="
            width: 40%;
            display: block;
            margin-left: auto;
            margin-right: auto;
        "><figcaption>
            Perform Tutorial 3

        </figcaption></figure>

<p>This will start the tutorial and log to the screen as it executes. When the tutorial is complete, click
“Exit Tutorial” to return to the Tutorial selection screen.</p>

</li>
        
    </ul>
</div>

<h1 id="setup">Setup</h1>

<p>We must first connect as was discussed in the
<a href="/OpenGoPro/tutorials/connect-ble">connecting BLE tutorial</a>. When enabling notifications,
one of the notification handlers described in the following sections will be used.</p>

<h1 id="response-overview">Response Overview</h1>

<p>In the preceding tutorials, we have been using a very simple response handling procedure where the notification
handler simply checks that the UUID is the expected UUID and that the status byte of the response is 0 (Success).
This has been fine since we were only performing specific operations where this works and we know that the sequence
always appears as such (connection sequence left out for brevity):</p>

<svg class="plantuml" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="184px" preserveaspectratio="none" style="width:448px;height:184px;background:#FFFFFF;" version="1.1" viewbox="0 0 448 184" width="448px" zoomandpan="magnify"><defs></defs><g><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="96" x2="96" y1="36.2969" y2="149.6953"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="383" x2="383" y1="36.2969" y2="149.6953"></line><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="183" x="5" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="169" x="12" y="24.9951">Open GoPro user device</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="183" x="5" y="148.6953"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="169" x="12" y="168.6904">Open GoPro user device</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="57" x="355" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="43" x="362" y="24.9951">GoPro</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="57" x="355" y="148.6953"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="43" x="362" y="168.6904">GoPro</text><path d="M39,51.2969 L39,76.2969 L441,76.2969 L441,61.2969 L431,51.2969 L39,51.2969 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"></path><path d="M431,51.2969 L431,61.2969 L441,61.2969 L431,51.2969 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"></path><text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="241" x="115" y="68.3638">devices are connected as in Tutorial 1</text><line style="stroke:#181818;stroke-width:1.0;" x1="381.5" x2="371.5" y1="102.5625" y2="98.5625"></line><line style="stroke:#181818;stroke-width:1.0;" x1="381.5" x2="371.5" y1="102.5625" y2="106.5625"></line><line style="stroke:#181818;stroke-width:1.0;" x1="96.5" x2="382.5" y1="102.5625" y2="102.5625"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="139" x="103.5" y="97.4966">Write to characteristic</text><line style="stroke:#181818;stroke-width:1.0;" x1="97.5" x2="107.5" y1="131.6953" y2="127.6953"></line><line style="stroke:#181818;stroke-width:1.0;" x1="97.5" x2="107.5" y1="131.6953" y2="135.6953"></line><line style="stroke:#181818;stroke-width:1.0;" x1="96.5" x2="382.5" y1="131.6953" y2="131.6953"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="263" x="113.5" y="126.6294">Notification Response (MSB == 0 (start))</text></g></svg>

<p>In actuality, responses can be more complicated. As described in the
<a href="/OpenGoPro/ble/protocol/data_protocol.html#packetization">BLE Spec</a>, responses can be be comprised of multiple
packets where each packet is &lt;= 20 bytes such as:</p>

<svg class="plantuml" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="272px" preserveaspectratio="none" style="width:497px;height:272px;background:#FFFFFF;" version="1.1" viewbox="0 0 497 272" width="497px" zoomandpan="magnify"><defs></defs><g><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="96" x2="96" y1="36.2969" y2="237.0938"></line><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="432" x2="432" y1="36.2969" y2="237.0938"></line><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="183" x="5" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="169" x="12" y="24.9951">Open GoPro user device</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="183" x="5" y="236.0938"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="169" x="12" y="256.0889">Open GoPro user device</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="57" x="404" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="43" x="411" y="24.9951">GoPro</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="57" x="404" y="236.0938"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthadjust="spacing" textlength="43" x="411" y="256.0889">GoPro</text><path d="M39,51.2969 L39,76.2969 L490,76.2969 L490,61.2969 L480,51.2969 L39,51.2969 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"></path><path d="M480,51.2969 L480,61.2969 L490,61.2969 L480,51.2969 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"></path><text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="241" x="139.5" y="68.3638">devices are connected as in Tutorial 1</text><line style="stroke:#181818;stroke-width:1.0;" x1="430.5" x2="420.5" y1="102.5625" y2="98.5625"></line><line style="stroke:#181818;stroke-width:1.0;" x1="430.5" x2="420.5" y1="102.5625" y2="106.5625"></line><line style="stroke:#181818;stroke-width:1.0;" x1="96.5" x2="431.5" y1="102.5625" y2="102.5625"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="139" x="103.5" y="97.4966">Write to characteristic</text><line style="stroke:#181818;stroke-width:1.0;" x1="97.5" x2="107.5" y1="131.6953" y2="127.6953"></line><line style="stroke:#181818;stroke-width:1.0;" x1="97.5" x2="107.5" y1="131.6953" y2="135.6953"></line><line style="stroke:#181818;stroke-width:1.0;" x1="96.5" x2="431.5" y1="131.6953" y2="131.6953"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="263" x="113.5" y="126.6294">Notification Response (MSB == 0 (start))</text><line style="stroke:#181818;stroke-width:1.0;" x1="97.5" x2="107.5" y1="160.8281" y2="156.8281"></line><line style="stroke:#181818;stroke-width:1.0;" x1="97.5" x2="107.5" y1="160.8281" y2="164.8281"></line><line style="stroke:#181818;stroke-width:1.0;" x1="96.5" x2="431.5" y1="160.8281" y2="160.8281"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="312" x="113.5" y="155.7622">Notification Response (MSB == 1 (continuation))</text><line style="stroke:#181818;stroke-width:1.0;" x1="97.5" x2="107.5" y1="189.9609" y2="185.9609"></line><line style="stroke:#181818;stroke-width:1.0;" x1="97.5" x2="107.5" y1="189.9609" y2="193.9609"></line><line style="stroke:#181818;stroke-width:1.0;" x1="96.5" x2="431.5" y1="189.9609" y2="189.9609"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="312" x="113.5" y="184.895">Notification Response (MSB == 1 (continuation))</text><line style="stroke:#181818;stroke-width:1.0;" x1="97.5" x2="107.5" y1="219.0938" y2="215.0938"></line><line style="stroke:#181818;stroke-width:1.0;" x1="97.5" x2="107.5" y1="219.0938" y2="223.0938"></line><line style="stroke:#181818;stroke-width:1.0;" x1="96.5" x2="431.5" y1="219.0938" y2="219.0938"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthadjust="spacing" textlength="312" x="113.5" y="214.0278">Notification Response (MSB == 1 (continuation))</text></g></svg>

<p>This requires the implementation of accumulating and parsing algorithms which will be described
<a href="#parsing-multiple-packet-tlv-responses">below</a>.</p>

<h1 id="parsing-a-one-packet-tlv-response">Parsing a One Packet TLV Response</h1>

<p>This section will describe how to parse one packet (&lt;= 20 byte) responses. A one-packet response
is formatted as such:</p>

<table>
  <thead>
    <tr>
      <th>Header (length)</th>
      <th>Operation ID</th>
      <th>Status</th>
      <th>Response</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1 byte</td>
      <td>1 byte</td>
      <td>1 bytes</td>
      <td>Length - 2 bytes</td>
    </tr>
  </tbody>
</table>

<h2 id="responses-with-payload-length-0">Responses with Payload Length 0</h2>

<p>These are the only responses that we have seen thus far through the first 2 tutorials. They
return a status but have a 0 length additional response. For example, consider
<a href="/OpenGoPro/tutorials/send-ble-commands#set-shutter">Set Shutter</a>. It returned a response
of:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>02:01:00
</code></pre></div></div>

<p>This equates to:</p>

<table>
  <thead>
    <tr>
      <th>Header (length)</th>
      <th>Command ID</th>
      <th>Status</th>
      <th>Response</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1 byte</td>
      <td>1 byte</td>
      <td>1 bytes</td>
      <td>Length - 2 bytes</td>
    </tr>
    <tr>
      <td>0x02</td>
      <td>0x01 == Set Shutter</td>
      <td>0x00 == Success</td>
      <td>(2 -2 = 0 bytes)</td>
    </tr>
  </tbody>
</table>

<p>We can see how this response includes the status but no additional response data. This type of
response will be used for most Commands and Setting Responses as seen in the
<a href="/OpenGoPro/tutorials/send-ble-commands">previous tutorial</a>.</p>

<h2 id="responses-with-payload">Responses with Payload</h2>

<p>However, there are some operations that do return additional response data. These are identified by the presence of
<code class="language-plaintext highlighter-rouge">parameters</code> in their Response documentation as shown in the red box here:</p>

<figure class="" style="
        display: block;
        text-align: center;
        margin: 10px auto;
    ">
    <img src="/OpenGoPro/assets/images/tutorials/complex_response_doc.png" alt="complex response example" style="
            width: 40%;
            display: block;
            margin-left: auto;
            margin-right: auto;
        "><figcaption>
            Response With Payload

        </figcaption></figure>

<p>In this tutorial, we will walk through creating a simple parser to parse the
<a href="/OpenGoPro/ble/features/query.html#get-open-gopro-version">Open GoPro Get Version Command</a> which is an example
of such an operation.</p>

<div class="callout tip">
<i class="fa fa-tools fa-2x" style="color: #ebc21c; margin: 0.25em;"></i><span>It is important to always query the version after connecting in order to know which API is supported.
See the relevant version of the BLE and / or WiFi spec for more details about each version.</span>
</div>

<p>First, we send the Get Version Command to the Command Request
<a href="/OpenGoPro/ble/protocol/ble_setup.html#configure-gatt-characteristics">UUID</a> in the same manner as commands
were sent in the previous tutorial:</p>

<div>
    <ul class="tab tab-linked" data-tab="cf0110e7-4789-4af4-af4e-1f7845840aa3">
        
            <li class="active">
                <a href="">python </a>
            </li>
        
            <li>
                <a href="">kotlin </a>
            </li>
        
        </ul>
        <ul class="tab-content" id="cf0110e7-4789-4af4-af4e-1f7845840aa3">
        
            <li class="active tab-content-container">
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">request_uuid</span> <span class="o">=</span> <span class="n">GoProUuid</span><span class="p">.</span><span class="n">COMMAND_REQ_UUID</span>
<span class="n">request</span> <span class="o">=</span> <span class="nf">bytes</span><span class="p">([</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">])</span>
<span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">write_gatt_char</span><span class="p">(</span><span class="n">request_uuid</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">await</span> <span class="n">event</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>  <span class="c1"># Wait to receive the notification response
</span></code></pre></div></div>

<p>We receive a response at the expected handle (as a TLV Response). This is logged as:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Getting the Open GoPro version...
Writing to GoProUuid.COMMAND_REQ_UUID: 01:51
Received response GoProUuid.COMMAND_RSP_UUID: 06:51:00:01:02:01:00
</span></code></pre></div></div>

</li>
        
            <li class="tab-content-container">
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">versionRequest</span> <span class="p">=</span> <span class="nf">ubyteArrayOf</span><span class="p">(</span><span class="mh">0x01U</span><span class="p">,</span> <span class="mh">0x51U</span><span class="p">)</span>
<span class="n">ble</span><span class="p">.</span><span class="nf">writeCharacteristic</span><span class="p">(</span><span class="n">goproAddress</span><span class="p">,</span> <span class="nc">GoProUUID</span><span class="p">.</span><span class="nc">CQ_COMMAND</span><span class="p">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">versionRequest</span><span class="p">)</span>
<span class="kd">var</span> <span class="py">tlvResponse</span> <span class="p">=</span> <span class="n">receivedResponses</span><span class="p">.</span><span class="nf">receive</span><span class="p">()</span> <span class="k">as</span> <span class="nc">Response</span><span class="p">.</span><span class="nc">Tlv</span>
</code></pre></div></div>

<p>We then receive a response at the expected handle. This is logged as:</p>

<p>This is logged as such:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Getting the Open GoPro version
</span><span class="gp">Writing characteristic b5f90072-aa8d-11e3-9046-0002a5d5c51b ==&gt;</span><span class="w"> </span>01:51
<span class="go">Wrote characteristic b5f90072-aa8d-11e3-9046-0002a5d5c51b
Characteristic b5f90073-aa8d-11e3-9046-0002a5d5c51b changed | value: 06:51:00:01:02:01:00
Received response on CQ_COMMAND_RSP
Received packet of length 6. 0 bytes remaining
</span></code></pre></div></div>

</li>
        
    </ul>
</div>

<p>This response equates to:</p>

<table>
  <thead>
    <tr>
      <th>Header (length)</th>
      <th>Command ID</th>
      <th>Status</th>
      <th>Response</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1 byte</td>
      <td>1 byte</td>
      <td>1 bytes</td>
      <td>Length - 2 bytes</td>
    </tr>
    <tr>
      <td>0x06</td>
      <td>0x51 == Get Version</td>
      <td>0x00 == Success</td>
      <td>0x01 0x02 0x01 0x00</td>
    </tr>
  </tbody>
</table>

<p>We can see that this response payload contains 4 additional bytes that need to be parsed. Using the information
from the <a href="/OpenGoPro/ble/features/query.html#get-open-gopro-version">Get Version Documentation</a>, we know to
parse this as:</p>

<table>
  <thead>
    <tr>
      <th>Byte</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x01</td>
      <td>Length of Major Version Number</td>
    </tr>
    <tr>
      <td>0x02</td>
      <td>Major Version Number of length 1 byte</td>
    </tr>
    <tr>
      <td>0x01</td>
      <td>Length of Minor Version Number</td>
    </tr>
    <tr>
      <td>0x00</td>
      <td>Minor Version Number of length 1 byte</td>
    </tr>
  </tbody>
</table>

<p>We implement this as follows. First, we parse the length, command ID, and status from the first 3 bytes of the response.
The remainder is stored as the payload. This is all of the common parsing across TLV Responses. Each individual
response will document how to further parse the payload.</p>

<div>
    <ul class="tab tab-linked" data-tab="709c7f09-491d-43d6-a62c-3feabe4279e9">
        
            <li class="active">
                <a href="">python </a>
            </li>
        
            <li>
                <a href="">kotlin </a>
            </li>
        
        </ul>
        <ul class="tab-content" id="709c7f09-491d-43d6-a62c-3feabe4279e9">
        
            <li class="active tab-content-container">
<div class="callout note">
<i class="fa fa-clipboard fa-2x" style="color: #3498db; margin: 0.25em;"></i><span>The snippets of code included in this section are taken from the <code class="language-plaintext highlighter-rouge">notification handler</code></span>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># First byte is the length of this response.
</span><span class="n">length</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># Second byte is the ID
</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># Third byte is the status
</span><span class="n">status</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="c1"># The remainder is the payload
</span><span class="n">payload</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span> <span class="p">:</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</code></pre></div></div>

</li>
        
            <li class="tab-content-container">
<div class="callout note">
<i class="fa fa-clipboard fa-2x" style="color: #3498db; margin: 0.25em;"></i><span>The snippets of code included in this section are taken from the <code class="language-plaintext highlighter-rouge">Response.Tlv.Parse</code> method</span>
</div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Parse header bytes</span>
<span class="n">tlvResponse</span><span class="p">.</span><span class="nf">parse</span><span class="p">()</span>

<span class="o">..</span><span class="p">.</span>

<span class="k">open</span> <span class="k">fun</span> <span class="nf">parse</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">require</span><span class="p">(</span><span class="n">isReceived</span><span class="p">)</span>
    <span class="n">id</span> <span class="p">=</span> <span class="n">rawBytes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">toInt</span><span class="p">()</span>
    <span class="n">status</span> <span class="p">=</span> <span class="n">rawBytes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">toInt</span><span class="p">()</span>
    <span class="c1">// Store remainder as payload</span>
    <span class="n">payload</span> <span class="p">=</span> <span class="n">rawBytes</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
<span class="p">}</span>

</code></pre></div></div>

</li>
        
    </ul>
</div>

<p>From the response definition, we know these parameters are one byte each and equate to the major and
the minor version so let’s print them (and all of the other response information) as such:</p>

<div>
    <ul class="tab tab-linked" data-tab="1de2d52f-e087-4dfb-a2ca-d7451410cc33">
        
            <li class="active">
                <a href="">python </a>
            </li>
        
            <li>
                <a href="">kotlin </a>
            </li>
        
        </ul>
        <ul class="tab-content" id="1de2d52f-e087-4dfb-a2ca-d7451410cc33">
        
            <li class="active tab-content-container">
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">major_length</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">payload</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">major</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="n">major_length</span><span class="p">]</span>
<span class="n">payload</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">major_length</span><span class="p">)</span>
<span class="n">minor_length</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">payload</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">minor</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[:</span><span class="n">minor_length</span><span class="p">]</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">The version is Open GoPro </span><span class="si">{</span><span class="n">major</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">minor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Received a response to </span><span class="si">{</span><span class="n">command_id</span><span class="o">=</span><span class="si">}</span><span class="s"> with </span><span class="si">{</span><span class="n">status</span><span class="o">=</span><span class="si">}</span><span class="s">: version=</span><span class="si">{</span><span class="n">major</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">minor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>which shows on the log as:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Received a response to command_id=81 with status=0, payload=01:02:01:00
The version is Open GoPro 2.0
</span></code></pre></div></div>

</li>
        
            <li class="tab-content-container">
<div class="callout note">
<i class="fa fa-clipboard fa-2x" style="color: #3498db; margin: 0.25em;"></i><span>The snippets of code included in this section are taken from the <code class="language-plaintext highlighter-rouge">OpenGoProVersion</code> <code class="language-plaintext highlighter-rouge">from_bytes</code> method. This class
is a simple data class to contain the Get Version information.</span>
</div>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="py">buf</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">toUByteArray</span><span class="p">()</span>
<span class="kd">val</span> <span class="py">minorLen</span> <span class="p">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">toInt</span><span class="p">()</span>
<span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
<span class="kd">val</span> <span class="py">minor</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">take</span><span class="p">(</span><span class="n">minorLen</span><span class="p">).</span><span class="nf">toInt</span><span class="p">()</span>
<span class="kd">val</span> <span class="py">majorLen</span> <span class="p">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">toInt</span><span class="p">()</span>
<span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
<span class="kd">val</span> <span class="py">major</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">take</span><span class="p">(</span><span class="n">majorLen</span><span class="p">).</span><span class="nf">toInt</span><span class="p">()</span>
<span class="k">return</span> <span class="nc">OpenGoProVersion</span><span class="p">(</span><span class="n">minor</span><span class="p">,</span> <span class="n">major</span><span class="p">)</span>
</code></pre></div></div>

<p>which shows on the log as such:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Received response: ID: 81, Status: 0, Payload: 01:02:01:00
Got the Open GoPro version successfully: 2.0
</span></code></pre></div></div>

</li>
        
    </ul>
</div>

<p><strong>Quiz time! 📚 ✏️</strong></p>

<div id="quiz_2f7b0a45-af5a-41bd-ad58-fb33fc23130f" class="quiz">
    <div>
        <div id="question_2f7b0a45-af5a-41bd-ad58-fb33fc23130f" class="quiz__question">What is the maximum size of an individual notification response packet at the Open GoPro application layer?</div>
        <div id="answers_2f7b0a45-af5a-41bd-ad58-fb33fc23130f">
        
            <input type="radio" name="question" value="A"><label>A: 20 bytes</label>
            <br>
        
            <input type="radio" name="question" value="B"><label>B: 256 bytes</label>
            <br>
        
            <input type="radio" name="question" value="C"><label>C: There is no maximum size</label>
            <br>
        
        </div>
    </div>
    <button onclick="showResults('2f7b0a45-af5a-41bd-ad58-fb33fc23130f', 'A')">Submit Answer</button>
    <div id="results_2f7b0a45-af5a-41bd-ad58-fb33fc23130f" style="display: none">
        <span id="correct_2f7b0a45-af5a-41bd-ad58-fb33fc23130f" style="display: none">  Correct!! 😃</span>
        <span id="incorrect_2f7b0a45-af5a-41bd-ad58-fb33fc23130f" style="display: none"> Incorrect!! 😭 The correct answer is A.</span>
        Responses can be composed of multiple packets where each packet is at
    maximum 20 bytes.
    </div>
</div>

<div id="quiz_721ba57b-6fa9-464f-8e55-dcb1245ade48" class="quiz">
    <div>
        <div id="question_721ba57b-6fa9-464f-8e55-dcb1245ade48" class="quiz__question">What is the maximum amount of bytes that one response can be composed of?</div>
        <div id="answers_721ba57b-6fa9-464f-8e55-dcb1245ade48">
        
            <input type="radio" name="question" value="A"><label>A: 20 bytes</label>
            <br>
        
            <input type="radio" name="question" value="B"><label>B: 256 bytes</label>
            <br>
        
            <input type="radio" name="question" value="C"><label>C: There is no maximum size</label>
            <br>
        
        </div>
    </div>
    <button onclick="showResults('721ba57b-6fa9-464f-8e55-dcb1245ade48', 'C')">Submit Answer</button>
    <div id="results_721ba57b-6fa9-464f-8e55-dcb1245ade48" style="display: none">
        <span id="correct_721ba57b-6fa9-464f-8e55-dcb1245ade48" style="display: none">  Correct!! 😃</span>
        <span id="incorrect_721ba57b-6fa9-464f-8e55-dcb1245ade48" style="display: none"> Incorrect!! 😭 The correct answer is C.</span>
        There is no limit on the amount of packets that can comprise a response.
    </div>
</div>

<div id="quiz_e5d7e5d3-9c3d-4931-8f52-2146322a4bc4" class="quiz">
    <div>
        <div id="question_e5d7e5d3-9c3d-4931-8f52-2146322a4bc4" class="quiz__question">How many packets are command responses composed of?</div>
        <div id="answers_e5d7e5d3-9c3d-4931-8f52-2146322a4bc4">
        
            <input type="radio" name="question" value="A"><label>A: Always 1 packet</label>
            <br>
        
            <input type="radio" name="question" value="B"><label>B: Always multiple packets.</label>
            <br>
        
            <input type="radio" name="question" value="C"><label>C: A variable amount of packets depending on the payload size</label>
            <br>
        
        </div>
    </div>
    <button onclick="showResults('e5d7e5d3-9c3d-4931-8f52-2146322a4bc4', 'C')">Submit Answer</button>
    <div id="results_e5d7e5d3-9c3d-4931-8f52-2146322a4bc4" style="display: none">
        <span id="correct_e5d7e5d3-9c3d-4931-8f52-2146322a4bc4" style="display: none">  Correct!! 😃</span>
        <span id="incorrect_e5d7e5d3-9c3d-4931-8f52-2146322a4bc4" style="display: none"> Incorrect!! 😭 The correct answer is C.</span>
        Command responses are sometimes 1 packet (just returning the status).
    Other times, command responses also contain a payload and can thus be multiple packets if the payload is big enough
    (i.e. in the case of Get Hardware Info). This is described in the per-command documentation in the BLE spec.
    </div>
</div>

<div id="quiz_4a64d912-ac00-4591-a65b-1c11adcaaefd" class="quiz">
    <div>
        <div id="question_4a64d912-ac00-4591-a65b-1c11adcaaefd" class="quiz__question">How many packets are setting responses comprised of?</div>
        <div id="answers_4a64d912-ac00-4591-a65b-1c11adcaaefd">
        
            <input type="radio" name="question" value="A"><label>A: Always 1 packet</label>
            <br>
        
            <input type="radio" name="question" value="B"><label>B: Always multiple packets.</label>
            <br>
        
            <input type="radio" name="question" value="C"><label>C: A variable amount of packets depending on the payload size</label>
            <br>
        
        </div>
    </div>
    <button onclick="showResults('4a64d912-ac00-4591-a65b-1c11adcaaefd', 'A')">Submit Answer</button>
    <div id="results_4a64d912-ac00-4591-a65b-1c11adcaaefd" style="display: none">
        <span id="correct_4a64d912-ac00-4591-a65b-1c11adcaaefd" style="display: none">  Correct!! 😃</span>
        <span id="incorrect_4a64d912-ac00-4591-a65b-1c11adcaaefd" style="display: none"> Incorrect!! 😭 The correct answer is A.</span>
        Settings Responses only ever contain the response status.
    </div>
</div>

<h1 id="parsing-multiple-packet-tlv-responses">Parsing Multiple Packet TLV Responses</h1>

<p>This section will describe parsing TLV responses that contain more than one packet. It will first describe how
to accumulate such responses and then provide a parsing example. We will be creating small <em>Response</em> and <em>TlvResponse</em>
classes that will be re-used for future tutorials.</p>

<h2 id="accumulating-the-response">Accumulating the Response</h2>

<p>The first step is to accumulate the multiple packets into one response. Whereas for all tutorials until now, we
have just used the header bytes of the response as the length, we now must completely parse the headers as they are
<a href="/OpenGoPro/ble/protocol/data_protocol.html#packet-headers">defined</a>, reproduced for reference here:</p>

<table border="1">
  <tbody>
    <tr>
        <td colspan="8">Byte 1</td>
        <td colspan="8">Byte 2 (optional)</td>
        <td colspan="8">Byte 3 (optional)</td>
    </tr>
    <tr>
        <td>7</td>
        <td>6</td>
        <td>5</td>
        <td>4</td>
        <td>3</td>
        <td>2</td>
        <td>1</td>
        <td>0</td>
        <td>7</td>
        <td>6</td>
        <td>5</td>
        <td>4</td>
        <td>3</td>
        <td>2</td>
        <td>1</td>
        <td>0</td>
        <td>7</td>
        <td>6</td>
        <td>5</td>
        <td>4</td>
        <td>3</td>
        <td>2</td>
        <td>1</td>
        <td>0</td>
    </tr>
    <tr>
        <td>0: Start</td>
        <td colspan="2">00: General</td>
        <td colspan="5">Message Length: 5 bits</td>
        <td colspan="16">
</td>
    </tr>
    <tr>
        <td>0: Start</td>
        <td colspan="2">01: Extended (13-bit)</td>
        <td colspan="13">Message Length: 13 bits</td>
        <td colspan="8">
</td>
    </tr>
    <tr>
        <td>0: Start</td>
        <td colspan="2">10: Extended (16-bit)</td>
        <td colspan="5">
</td>
        <td colspan="16">Message Length: 16 bits</td>
    </tr>
    <tr>
        <td>0: Start</td>
        <td colspan="2">11: Reserved</td>
        <td colspan="21">
</td>
    </tr>
    <tr>
        <td>1: Continuation</td>
        <td colspan="24">
</td>
    </tr>
  </tbody>
</table>

<p>The basic accumulation algorithm (which is implemented in the <em>Response.Accumulate</em> method) is as follows:</p>

<hr>

<div class="md_column">
<div>
    <p>Is the continuation bit set?</p>

    <div>
    <ul class="tab tab-linked" data-tab="44bf4cc6-caef-4275-9b41-5d4e426d664f">
        
            <li class="active">
                <a href="">python </a>
            </li>
        
            <li>
                <a href="">kotlin </a>
            </li>
        
        </ul>
        <ul class="tab-content" id="44bf4cc6-caef-4275-9b41-5d4e426d664f">
        
            <li class="active tab-content-container">
<div class="callout note">
<i class="fa fa-clipboard fa-2x" style="color: #3498db; margin: 0.25em;"></i><span>The example script that will be walked through for this section is <code class="language-plaintext highlighter-rouge">ble_command_get_hardware_info.py</code>.</span>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CONT_MASK</span><span class="p">:</span>
    <span class="n">buf</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="bp">...</span>
</code></pre></div></div>

</li>
        
            <li class="tab-content-container">
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">first</span><span class="p">().</span><span class="nf">and</span><span class="p">(</span><span class="nc">Mask</span><span class="p">.</span><span class="nc">Continuation</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="p">==</span> <span class="nc">Mask</span><span class="p">.</span><span class="nc">Continuation</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span> <span class="c1">// Pop the header byte</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// This is a new packet</span>
    <span class="o">..</span><span class="p">.</span>
</code></pre></div></div>

</li>
        
    </ul>
</div>

    <p>No, the continuation bit was not set. Therefore create new response, then get its length.</p>

    <div>
    <ul class="tab tab-linked" data-tab="22a53539-86bf-4a81-bf53-0bf382bba1a3">
        
            <li class="active">
                <a href="">python </a>
            </li>
        
            <li>
                <a href="">kotlin </a>
            </li>
        
        </ul>
        <ul class="tab-content" id="22a53539-86bf-4a81-bf53-0bf382bba1a3">
        
            <li class="active tab-content-container">
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This is a new packet so start with an empty byte array
</span><span class="n">self</span><span class="p">.</span><span class="nb">bytes</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">()</span>
<span class="n">hdr</span> <span class="o">=</span> <span class="nc">Header</span><span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HDR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span>
<span class="k">if</span> <span class="n">hdr</span> <span class="ow">is</span> <span class="n">Header</span><span class="p">.</span><span class="n">GENERAL</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="n">bytes_remaining</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">GEN_LEN_MASK</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="k">elif</span> <span class="n">hdr</span> <span class="ow">is</span> <span class="n">Header</span><span class="p">.</span><span class="n">EXT_13</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="n">bytes_remaining</span> <span class="o">=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">EXT_13_BYTE0_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="k">elif</span> <span class="n">hdr</span> <span class="ow">is</span> <span class="n">Header</span><span class="p">.</span><span class="n">EXT_16</span><span class="p">:</span>
    <span class="n">self</span><span class="p">.</span><span class="n">bytes_remaining</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
</code></pre></div></div>

</li>
        
            <li class="tab-content-container">
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// This is a new packet so start with empty array</span>
<span class="n">packet</span> <span class="p">=</span> <span class="nf">ubyteArrayOf</span><span class="p">()</span>
<span class="k">when</span> <span class="p">(</span><span class="nc">Header</span><span class="p">.</span><span class="nf">fromValue</span><span class="p">((</span><span class="n">buf</span><span class="p">.</span><span class="nf">first</span><span class="p">()</span> <span class="n">and</span> <span class="nc">Mask</span><span class="p">.</span><span class="nc">Header</span><span class="p">.</span><span class="n">value</span><span class="p">).</span><span class="nf">toInt</span><span class="p">()</span> <span class="n">shr</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
    <span class="nc">Header</span><span class="p">.</span><span class="nc">GENERAL</span> <span class="p">-&gt;</span> <span class="p">{</span>
        <span class="n">bytesRemaining</span> <span class="p">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">and</span><span class="p">(</span><span class="nc">Mask</span><span class="p">.</span><span class="nc">GenLength</span><span class="p">.</span><span class="n">value</span><span class="p">).</span><span class="nf">toInt</span><span class="p">()</span>
        <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="nc">Header</span><span class="p">.</span><span class="nc">EXT_13</span> <span class="p">-&gt;</span> <span class="p">{</span>
        <span class="n">bytesRemaining</span> <span class="p">=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">and</span><span class="p">(</span><span class="nc">Mask</span><span class="p">.</span><span class="nc">Ext13Byte0</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">toLong</span><span class="p">()</span> <span class="n">shl</span> <span class="mi">8</span><span class="p">)</span> <span class="n">or</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">toLong</span><span class="p">()).</span><span class="nf">toInt</span><span class="p">()</span>
        <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="nc">Header</span><span class="p">.</span><span class="nc">EXT_16</span> <span class="p">-&gt;</span> <span class="p">{</span>
        <span class="n">bytesRemaining</span> <span class="p">=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">toLong</span><span class="p">()</span> <span class="n">shl</span> <span class="mi">8</span><span class="p">)</span> <span class="n">or</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">toLong</span><span class="p">()).</span><span class="nf">toInt</span><span class="p">()</span>
        <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="nc">Header</span><span class="p">.</span><span class="nc">RESERVED</span> <span class="p">-&gt;</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nc">Exception</span><span class="p">(</span><span class="s">"Unexpected RESERVED header"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

</li>
        
    </ul>
</div>

    <p>Append current packet to response and decrement bytes remaining.</p>

    <div>
    <ul class="tab tab-linked" data-tab="1b6781ab-a7e8-44a2-b16f-6761c0e99660">
        
            <li class="active">
                <a href="">python </a>
            </li>
        
            <li>
                <a href="">kotlin </a>
            </li>
        
        </ul>
        <ul class="tab-content" id="1b6781ab-a7e8-44a2-b16f-6761c0e99660">
        
            <li class="active tab-content-container">
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Append payload to buffer and update remaining / complete
</span><span class="n">self</span><span class="p">.</span><span class="nb">bytes</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="n">self</span><span class="p">.</span><span class="n">bytes_remaining</span> <span class="o">-=</span> <span class="nf">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</code></pre></div></div>

</li>
        
            <li class="tab-content-container">
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Accumulate the payload now that headers are handled and dropped</span>
<span class="n">packet</span> <span class="p">+=</span> <span class="n">buf</span>
<span class="n">bytesRemaining</span> <span class="p">-=</span> <span class="n">buf</span><span class="p">.</span><span class="n">size</span>
</code></pre></div></div>

</li>
        
    </ul>
</div>

    <p>In the notification handler, we are then enqueueing the received response if there are no bytes remaining.</p>

    <div>
    <ul class="tab tab-linked" data-tab="fd510566-6b9d-4b69-a468-d539b2470bbf">
        
            <li class="active">
                <a href="">python </a>
            </li>
        
            <li>
                <a href="">kotlin </a>
            </li>
        
        </ul>
        <ul class="tab-content" id="fd510566-6b9d-4b69-a468-d539b2470bbf">
        
            <li class="active tab-content-container">
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">is_received</span><span class="p">:</span>
        <span class="bp">...</span>
        <span class="k">await</span> <span class="n">received_responses</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></div>

<p>and finally parsing the payload back in the main task after it receives the accumulated response from the queue which,
at the current TLV Response level, is just extracting the ID, status, and payload:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TlvResponse</span><span class="p">(</span><span class="n">Response</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="nb">id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">raw_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">raw_bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">raw_bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

<span class="bp">...</span>

<span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">received_responses</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span>
<span class="n">response</span><span class="p">.</span><span class="nf">parse</span><span class="p">()</span>
</code></pre></div></div>

</li>
        
            <li class="tab-content-container">
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">isReceived</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uuid</span> <span class="p">==</span> <span class="nc">GoProUUID</span><span class="p">.</span><span class="nc">CQ_COMMAND_RSP</span><span class="p">)</span> <span class="p">{</span>
        <span class="nc">CoroutineScope</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">).</span><span class="nf">launch</span> <span class="p">{</span> <span class="n">receivedResponses</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="o">..</span><span class="p">.</span>
</code></pre></div></div>

</li>
        
    </ul>
</div>

  </div>

<div style="flex:80%; width:50%; height: 50%">
    <p><br><br><br></p>
    <svg class="plantuml" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" height="828px" preserveaspectratio="none" style="width:597px;height:828px;background:#FFFFFF;" version="1.1" viewbox="0 0 597 828" width="597.6px" zoomandpan="magnify"><defs></defs><g><rect fill="#F1F1F1" height="61.1438" rx="22.5" ry="22.5" style="stroke:#181818;stroke-width:0.9;" width="352.8" x="98.1" y="204.068"></rect><text fill="#000000" font-family="sans-serif" font-size="21.6" lengthadjust="spacing" textlength="316.8" x="116.1" y="242.1176">Create new empty response</text><rect fill="#F1F1F1" height="61.1438" rx="22.5" ry="22.5" style="stroke:#181818;stroke-width:0.9;" width="401.4" x="73.8" y="301.2117"></rect><text fill="#000000" font-family="sans-serif" font-size="21.6" lengthadjust="spacing" textlength="365.4" x="91.8" y="339.2613">Get remaining bytes (i.e. length)</text><polygon fill="#F1F1F1" points="167.4,116.9438,381.6,116.9438,403.2,138.5438,381.6,160.1438,167.4,160.1438,145.8,138.5438,167.4,116.9438" style="stroke:#181818;stroke-width:0.9;"></polygon><text fill="#000000" font-family="sans-serif" font-size="19.8" lengthadjust="spacing" textlength="25.2" x="281.7" y="178.5226">no</text><text fill="#000000" font-family="sans-serif" font-size="19.8" lengthadjust="spacing" textlength="214.2" x="167.4" y="145.3983">Continuation Bit Set?</text><text fill="#000000" font-family="sans-serif" font-size="19.8" lengthadjust="spacing" textlength="36" x="403.2" y="133.8741">yes</text><rect fill="#F1F1F1" height="61.1438" rx="22.5" ry="22.5" style="stroke:#181818;stroke-width:0.9;" width="509.4" x="19.8" y="453.0797"></rect><text fill="#000000" font-family="sans-serif" font-size="21.6" lengthadjust="spacing" textlength="473.4" x="37.8" y="491.1293">Append packet to accumulating response</text><rect fill="#F1F1F1" height="61.1438" rx="22.5" ry="22.5" style="stroke:#181818;stroke-width:0.9;" width="347.4" x="100.8" y="550.2234"></rect><text fill="#000000" font-family="sans-serif" font-size="21.6" lengthadjust="spacing" textlength="311.4" x="118.8" y="588.273">Decrement Bytes remaining</text><rect fill="#F1F1F1" height="61.1438" rx="22.5" ry="22.5" style="stroke:#181818;stroke-width:0.9;" width="284.4" x="132.3" y="19.8"></rect><text fill="#000000" font-family="sans-serif" font-size="21.6" lengthadjust="spacing" textlength="248.4" x="150.3" y="57.8496">Read Available Packet</text><polygon fill="#F1F1F1" points="185.4,647.3672,363.6,647.3672,385.2,668.9672,363.6,690.5672,185.4,690.5672,163.8,668.9672,185.4,647.3672" style="stroke:#181818;stroke-width:0.9;"></polygon><text fill="#000000" font-family="sans-serif" font-size="19.8" lengthadjust="spacing" textlength="25.2" x="281.7" y="708.946">no</text><text fill="#000000" font-family="sans-serif" font-size="19.8" lengthadjust="spacing" textlength="178.2" x="185.4" y="675.8218">Bytes remaining?</text><text fill="#000000" font-family="sans-serif" font-size="19.8" lengthadjust="spacing" textlength="36" x="385.2" y="664.2976">yes</text><rect fill="#F1F1F1" height="61.1438" rx="22.5" ry="22.5" style="stroke:#181818;stroke-width:0.9;" width="293.4" x="127.8" y="747.646"></rect><text fill="#000000" font-family="sans-serif" font-size="21.6" lengthadjust="spacing" textlength="257.4" x="145.8" y="785.6956">Parse Received Packet</text><line style="stroke:#181818;stroke-width:1.8;" x1="274.5" x2="274.5" y1="265.2117" y2="301.2117"></line><polygon fill="#181818" points="267.3,283.2117,274.5,301.2117,281.7,283.2117,274.5,290.4117" style="stroke:#181818;stroke-width:1.8;"></polygon><line style="stroke:#181818;stroke-width:1.8;" x1="274.5" x2="274.5" y1="160.1438" y2="204.068"></line><polygon fill="#181818" points="267.3,186.068,274.5,204.068,281.7,186.068,274.5,193.268" style="stroke:#181818;stroke-width:1.8;"></polygon><line style="stroke:#181818;stroke-width:1.8;" x1="403.2" x2="493.2" y1="138.5438" y2="138.5438"></line><line style="stroke:#181818;stroke-width:1.8;" x1="493.2" x2="493.2" y1="138.5438" y2="417.0797"></line><polygon fill="#181818" points="486,399.0797,493.2,417.0797,500.4,399.0797,493.2,406.2797" style="stroke:#181818;stroke-width:1.8;"></polygon><line style="stroke:#181818;stroke-width:1.8;" x1="493.2" x2="274.5" y1="417.0797" y2="417.0797"></line><line style="stroke:#181818;stroke-width:1.8;" x1="274.5" x2="274.5" y1="417.0797" y2="426.0797"></line><line style="stroke:#181818;stroke-width:1.8;" x1="274.5" x2="274.5" y1="362.3555" y2="417.0797"></line><polygon fill="#181818" points="267.3,399.0797,274.5,417.0797,281.7,399.0797,274.5,406.2797" style="stroke:#181818;stroke-width:1.8;"></polygon><line style="stroke:#181818;stroke-width:1.8;" x1="274.5" x2="274.5" y1="426.0797" y2="453.0797"></line><polygon fill="#181818" points="267.3,435.0797,274.5,453.0797,281.7,435.0797,274.5,442.2797" style="stroke:#181818;stroke-width:1.8;"></polygon><line style="stroke:#181818;stroke-width:1.8;" x1="274.5" x2="274.5" y1="514.2234" y2="550.2234"></line><polygon fill="#181818" points="267.3,532.2234,274.5,550.2234,281.7,532.2234,274.5,539.4234" style="stroke:#181818;stroke-width:1.8;"></polygon><line style="stroke:#181818;stroke-width:1.8;" x1="274.5" x2="274.5" y1="80.9438" y2="116.9438"></line><polygon fill="#181818" points="267.3,98.9438,274.5,116.9438,281.7,98.9438,274.5,106.1438" style="stroke:#181818;stroke-width:1.8;"></polygon><line style="stroke:#181818;stroke-width:1.8;" x1="385.2" x2="550.8" y1="668.9672" y2="668.9672"></line><polygon fill="#181818" points="543.6,396.5695,550.8,378.5695,558,396.5695,550.8,389.3695" style="stroke:#181818;stroke-width:1.8;"></polygon><line style="stroke:#181818;stroke-width:1.8;" x1="550.8" x2="550.8" y1="50.3719" y2="668.9672"></line><line style="stroke:#181818;stroke-width:1.8;" x1="550.8" x2="416.7" y1="50.3719" y2="50.3719"></line><polygon fill="#181818" points="434.7,43.1719,416.7,50.3719,434.7,57.5719,427.5,50.3719" style="stroke:#181818;stroke-width:1.8;"></polygon><line style="stroke:#181818;stroke-width:1.8;" x1="274.5" x2="274.5" y1="611.3672" y2="647.3672"></line><polygon fill="#181818" points="267.3,629.3672,274.5,647.3672,281.7,629.3672,274.5,636.5672" style="stroke:#181818;stroke-width:1.8;"></polygon><line style="stroke:#181818;stroke-width:1.8;" x1="274.5" x2="274.5" y1="690.5672" y2="747.646"></line><polygon fill="#181818" points="267.3,729.646,274.5,747.646,281.7,729.646,274.5,736.846" style="stroke:#181818;stroke-width:1.8;"></polygon></g></svg>
  </div>
</div>

<hr>

<p>We can see this in action when we send the
<a href="/OpenGoPro/ble/features/query.html#get-hardware-info">Get Hardware Info</a> Command:</p>

<div>
    <ul class="tab tab-linked" data-tab="1f83de98-68b2-4b08-85d4-1db16557fffc">
        
            <li class="active">
                <a href="">python </a>
            </li>
        
            <li>
                <a href="">kotlin </a>
            </li>
        
        </ul>
        <ul class="tab-content" id="1f83de98-68b2-4b08-85d4-1db16557fffc">
        
            <li class="active tab-content-container">
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">request_uuid</span> <span class="o">=</span> <span class="n">GoProUuid</span><span class="p">.</span><span class="n">COMMAND_REQ_UUID</span>
<span class="n">request</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">([</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">])</span>
<span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">write_gatt_char</span><span class="p">(</span><span class="n">request_uuid</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">received_responses</span><span class="p">.</span><span class="nf">get</span><span class="p">()</span>
</code></pre></div></div>

</li>
        
            <li class="tab-content-container">
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">hardwareInfoRequest</span> <span class="p">=</span> <span class="nf">ubyteArrayOf</span><span class="p">(</span><span class="mh">0x01U</span><span class="p">,</span> <span class="mh">0x3CU</span><span class="p">)</span>
<span class="n">ble</span><span class="p">.</span><span class="nf">writeCharacteristic</span><span class="p">(</span><span class="n">goproAddress</span><span class="p">,</span> <span class="nc">GoProUUID</span><span class="p">.</span><span class="nc">CQ_COMMAND</span><span class="p">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">hardwareInfoRequest</span><span class="p">)</span>
</code></pre></div></div>

</li>
        
    </ul>
</div>

<p>Then, in the notification handler, we continuously receive and accumulate packets (per UUID) until we have
received an entire response, at which point we perform common TLV parsing (via the <code class="language-plaintext highlighter-rouge">TlvResponse</code>’s <code class="language-plaintext highlighter-rouge">parse</code> method)
to extract Command ID, Status, and payload. Then we enqueue the received response to notify the writer that the response
is ready. Finally we reset the per-UUID response to prepare it to receive a new response.</p>

<div class="callout note">
<i class="fa fa-clipboard fa-2x" style="color: #3498db; margin: 0.25em;"></i><span>This notification handler is only designed to handle TlvResponses. This is fine for this tutorial since that is all
we will be receiving.</span>
</div>

<div>
    <ul class="tab tab-linked" data-tab="e2c43410-cbdd-49fe-84f9-e77f340ee856">
        
            <li class="active">
                <a href="">python </a>
            </li>
        
            <li>
                <a href="">kotlin </a>
            </li>
        
        </ul>
        <ul class="tab-content" id="e2c43410-cbdd-49fe-84f9-e77f340ee856">
        
            <li class="active tab-content-container">
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">request_uuid</span> <span class="o">=</span> <span class="n">GoProUuid</span><span class="p">.</span><span class="n">COMMAND_REQ_UUID</span>
<span class="n">response_uuid</span> <span class="o">=</span> <span class="n">GoProUuid</span><span class="p">.</span><span class="n">COMMAND_RSP_UUID</span>
<span class="n">responses_by_uuid</span> <span class="o">=</span> <span class="n">GoProUuid</span><span class="p">.</span><span class="nf">dict_by_uuid</span><span class="p">(</span><span class="n">TlvResponse</span><span class="p">)</span>
<span class="n">received_responses</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Queue</span><span class="p">[</span><span class="n">TlvResponse</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nc">Queue</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">tlv_notification_handler</span><span class="p">(</span><span class="n">characteristic</span><span class="p">:</span> <span class="n">BleakGATTCharacteristic</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytearray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="nc">GoProUuid</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">services</span><span class="p">.</span><span class="n">characteristics</span><span class="p">[</span><span class="n">characteristic</span><span class="p">.</span><span class="n">handle</span><span class="p">].</span><span class="n">uuid</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">responses_by_uuid</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">accumulate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">is_received</span><span class="p">:</span>
        <span class="c1"># If this is the correct handle, enqueue it for processing
</span>        <span class="k">if</span> <span class="n">uuid</span> <span class="ow">is</span> <span class="n">response_uuid</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Received the get hardware info response</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">received_responses</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="c1"># Anything else is unexpected. This shouldn't happen
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">Unexpected response</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># Reset the per-UUID response
</span>        <span class="n">responses_by_uuid</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="nc">TlvResponse</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
</code></pre></div></div>

</li>
        
            <li class="tab-content-container">
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">fun</span> <span class="nf">notificationHandler</span><span class="p">(</span><span class="n">characteristic</span><span class="p">:</span> <span class="nc">UUID</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nc">UByteArray</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">..</span><span class="p">.</span>
    <span class="n">responsesByUuid</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span> <span class="n">response</span> <span class="p">-&gt;</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">accumulate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">isReceived</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">uuid</span> <span class="p">==</span> <span class="nc">GoProUUID</span><span class="p">.</span><span class="nc">CQ_COMMAND_RSP</span><span class="p">)</span> <span class="p">{</span>
                <span class="nc">CoroutineScope</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">).</span><span class="nf">launch</span> <span class="p">{</span> <span class="n">receivedResponses</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">}</span>
            <span class="p">}</span>
            <span class="o">..</span><span class="p">.</span>
            <span class="n">responsesByUuid</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="p">=</span> <span class="nc">Response</span><span class="p">.</span><span class="nf">muxByUuid</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

</li>
        
    </ul>
</div>

<p>We can see the individual packets being accumulated in the log:</p>

<div>
    <ul class="tab tab-linked" data-tab="f23ee8ec-8c0b-404b-8200-b31bb06107a8">
        
            <li class="active">
                <a href="">python </a>
            </li>
        
            <li>
                <a href="">kotlin </a>
            </li>
        
        </ul>
        <ul class="tab-content" id="f23ee8ec-8c0b-404b-8200-b31bb06107a8">
        
            <li class="active tab-content-container">
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Getting the camera's hardware info...
Writing to GoProUuid.COMMAND_REQ_UUID: 01:3c
Received response at handle 47: 20:62:3c:00:04:00:00:00:3e:0c:48:45:52:4f:31:32:20:42:6c:61
self.bytes_remaining=80
Received response at handle 47: 80:63:6b:04:30:78:30:35:0f:48:32:33:2e:30:31:2e:30:31:2e:39
self.bytes_remaining=61
Received response at handle 47: 81:39:2e:35:36:0e:43:33:35:30:31:33:32:34:35:30:30:37:30:32
self.bytes_remaining=42
Received response at handle 47: 82:11:48:45:52:4f:31:32:20:42:6c:61:63:6b:64:65:62:75:67:0c
self.bytes_remaining=23
Received response at handle 47: 83:32:36:37:34:66:37:66:36:36:31:30:34:01:00:01:01:01:00:02
self.bytes_remaining=4
Received response at handle 47: 84:5b:5d:01:01
self.bytes_remaining=0
Received the get hardware info response
</span></code></pre></div></div>

</li>
        
            <li class="tab-content-container">
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Getting the Hardware Info
</span><span class="gp">Writing characteristic b5f90072-aa8d-11e3-9046-0002a5d5c51b ==&gt;</span><span class="w"> </span>01:3C
<span class="go">Characteristic b5f90073-aa8d-11e3-9046-0002a5d5c51b changed | value: 20:5B:3C:00:04:00:00:00:3E:0C:48:45:52:4F:31:32:20:42:6C:61
Received response on CQ_COMMAND_RSP
Received packet of length 18. 73 bytes remaining
Characteristic b5f90073-aa8d-11e3-9046-0002a5d5c51b changed | value: 80:63:6B:04:30:78:30:35:0F:48:32:33:2E:30:31:2E:30:31:2E:39
Received response on CQ_COMMAND_RSP
Received packet of length 19. 54 bytes remaining
Wrote characteristic b5f90072-aa8d-11e3-9046-0002a5d5c51b
Characteristic b5f90073-aa8d-11e3-9046-0002a5d5c51b changed | value: 81:39:2E:35:36:0E:43:33:35:30:31:33:32:34:35:30:30:37:30:32
Received response on CQ_COMMAND_RSP
Received packet of length 19. 35 bytes remaining
Characteristic b5f90073-aa8d-11e3-9046-0002a5d5c51b changed | value: 82:0A:47:50:32:34:35:30:30:37:30:32:0C:32:36:37:34:66:37:66
Received response on CQ_COMMAND_RSP
Received packet of length 19. 16 bytes remaining
Characteristic b5f90073-aa8d-11e3-9046-0002a5d5c51b changed | value: 83:36:36:31:30:34:01:00:01:01:01:00:02:5B:5D:01:01
Received response on CQ_COMMAND_RSP
Received packet of length 16. 0 bytes remaining
</span></code></pre></div></div>

</li>
        
    </ul>
</div>

<p>At this point the response has been accumulated. We then parse and log the payload using the
<a href="/OpenGoPro/ble/features/query.html#get-hardware-info">Get Hardware Info</a> response documentation:</p>

<div>
    <ul class="tab tab-linked" data-tab="2a9510eb-2412-4a8d-aa04-78d62ffaa8dd">
        
            <li class="active">
                <a href="">python </a>
            </li>
        
            <li>
                <a href="">kotlin </a>
            </li>
        
        </ul>
        <ul class="tab-content" id="2a9510eb-2412-4a8d-aa04-78d62ffaa8dd">
        
            <li class="active tab-content-container">
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hardware_info</span> <span class="o">=</span> <span class="n">HardwareInfo</span><span class="p">.</span><span class="nf">from_bytes</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">payload</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Received hardware info: </span><span class="si">{</span><span class="n">hardware_info</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>where the parsing is done as such:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_bytes</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HardwareInfo</span><span class="p">:</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nf">bytearray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># Get model number
</span>        <span class="n">model_num_length</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="nf">from_bytes</span><span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="n">model_num_length</span><span class="p">])</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">model_num_length</span><span class="p">:]</span>
        <span class="c1"># Get model name
</span>        <span class="n">model_name_length</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="n">model_name_length</span><span class="p">]).</span><span class="nf">decode</span><span class="p">()</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">model_name_length</span><span class="p">:]</span>
        <span class="c1"># Advance past deprecated bytes
</span>        <span class="n">deprecated_length</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">deprecated_length</span><span class="p">:]</span>
        <span class="c1"># Get firmware version
</span>        <span class="n">firmware_length</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">firmware</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="n">firmware_length</span><span class="p">]).</span><span class="nf">decode</span><span class="p">()</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">firmware_length</span><span class="p">:]</span>
        <span class="c1"># Get serial number
</span>        <span class="n">serial_length</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">serial</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="n">serial_length</span><span class="p">]).</span><span class="nf">decode</span><span class="p">()</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">serial_length</span><span class="p">:]</span>
        <span class="c1"># Get AP SSID
</span>        <span class="n">ssid_length</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ssid</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="n">ssid_length</span><span class="p">]).</span><span class="nf">decode</span><span class="p">()</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">ssid_length</span><span class="p">:]</span>
        <span class="c1"># Get MAC address
</span>        <span class="n">mac_length</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mac</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[:</span><span class="n">mac_length</span><span class="p">]).</span><span class="nf">decode</span><span class="p">()</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">mac_length</span><span class="p">:]</span>

        <span class="k">return</span> <span class="nf">cls</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">firmware</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">mac</span><span class="p">)</span>
</code></pre></div></div>

<p>This logs as:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Parsed hardware info: {
        "model_name": "HERO12 Black",
        "firmware_version": "H23.01.01.99.56",
        "serial_number": "C3501324500702",
        "ap_ssid": "HERO12 Blackdebug",
        "ap_mac_address": "2674f7f66104"
    }
</span></code></pre></div></div>

</li>
        
            <li class="tab-content-container">
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tlvResponse</span><span class="p">.</span><span class="nf">parse</span><span class="p">()</span>
<span class="kd">val</span> <span class="py">hardwareInfo</span> <span class="p">=</span> <span class="nc">HardwareInfo</span><span class="p">.</span><span class="nf">fromBytes</span><span class="p">(</span><span class="n">tlvResponse</span><span class="p">.</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div></div>

<p>where the parsing is done as such:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">fromBytes</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nc">UByteArray</span><span class="p">):</span> <span class="nc">HardwareInfo</span> <span class="p">{</span>
    <span class="c1">// Parse header bytes</span>
    <span class="kd">var</span> <span class="py">buf</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="c1">// Get model number</span>
    <span class="kd">val</span> <span class="py">modelNumLength</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">first</span><span class="p">().</span><span class="nf">toInt</span><span class="p">()</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">model</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">take</span><span class="p">(</span><span class="n">modelNumLength</span><span class="p">).</span><span class="nf">toInt</span><span class="p">()</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">modelNumLength</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="c1">// Get model name</span>
    <span class="kd">val</span> <span class="py">modelNameLength</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">first</span><span class="p">().</span><span class="nf">toInt</span><span class="p">()</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">modelName</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">take</span><span class="p">(</span><span class="n">modelNameLength</span><span class="p">).</span><span class="nf">decodeToString</span><span class="p">()</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">modelNameLength</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="c1">// Advance past deprecated bytes</span>
    <span class="kd">val</span> <span class="py">deprecatedLength</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">first</span><span class="p">().</span><span class="nf">toInt</span><span class="p">()</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">deprecatedLength</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="c1">// Get firmware version</span>
    <span class="kd">val</span> <span class="py">firmwareLength</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">first</span><span class="p">().</span><span class="nf">toInt</span><span class="p">()</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">firmware</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">take</span><span class="p">(</span><span class="n">firmwareLength</span><span class="p">).</span><span class="nf">decodeToString</span><span class="p">()</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">firmwareLength</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="c1">// Get serial number</span>
    <span class="kd">val</span> <span class="py">serialLength</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">first</span><span class="p">().</span><span class="nf">toInt</span><span class="p">()</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">serial</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">take</span><span class="p">(</span><span class="n">serialLength</span><span class="p">).</span><span class="nf">decodeToString</span><span class="p">()</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">serialLength</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="c1">// Get AP SSID</span>
    <span class="kd">val</span> <span class="py">ssidLength</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">first</span><span class="p">().</span><span class="nf">toInt</span><span class="p">()</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">ssid</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">take</span><span class="p">(</span><span class="n">ssidLength</span><span class="p">).</span><span class="nf">decodeToString</span><span class="p">()</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">ssidLength</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="c1">// Get MAC Address</span>
    <span class="kd">val</span> <span class="py">macLength</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">first</span><span class="p">().</span><span class="nf">toInt</span><span class="p">()</span>
    <span class="n">buf</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">toUByteArray</span><span class="p">()</span>
    <span class="kd">val</span> <span class="py">mac</span> <span class="p">=</span> <span class="n">buf</span><span class="p">.</span><span class="nf">take</span><span class="p">(</span><span class="n">macLength</span><span class="p">).</span><span class="nf">decodeToString</span><span class="p">()</span>

    <span class="k">return</span> <span class="nc">HardwareInfo</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">modelName</span><span class="p">,</span> <span class="n">firmware</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">mac</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This logs as:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Got the Hardware Info successfully: HardwareInfo(
    modelNumber=1040187392,
    modelName=HERO12 Black,
    firmwareVersion=H23.01.01.99.56,
    serialNumber=C3501324500702,
    apSsid=GP24500702,
    apMacAddress=2674f7f66104
)
</span></code></pre></div></div>

</li>
        
    </ul>
</div>

<p><strong>Quiz time! 📚 ✏️</strong></p>

<div id="quiz_6b10d51e-678e-4761-89ab-3a97e2045e77" class="quiz">
    <div>
        <div id="question_6b10d51e-678e-4761-89ab-3a97e2045e77" class="quiz__question">How can we know that a response has been completely received?</div>
        <div id="answers_6b10d51e-678e-4761-89ab-3a97e2045e77">
        
            <input type="radio" name="question" value="A"><label>A: The stop bit will be set in the header</label>
            <br>
        
            <input type="radio" name="question" value="B"><label>B: The response has accumulated length bytes</label>
            <br>
        
            <input type="radio" name="question" value="C"><label>C: By checking for the end of frame (EOF) sentinel character</label>
            <br>
        
        </div>
    </div>
    <button onclick="showResults('6b10d51e-678e-4761-89ab-3a97e2045e77', 'B')">Submit Answer</button>
    <div id="results_6b10d51e-678e-4761-89ab-3a97e2045e77" style="display: none">
        <span id="correct_6b10d51e-678e-4761-89ab-3a97e2045e77" style="display: none">  Correct!! 😃</span>
        <span id="incorrect_6b10d51e-678e-4761-89ab-3a97e2045e77" style="display: none"> Incorrect!! 😭 The correct answer is B.</span>
        The length of the entire response is parsed from the first packet. We
        then accumulate packets, keeping track of the received length, until all of the bytes
        have been received. A and C are just made up 😜.
    </div>
</div>

<h1 id="troubleshooting">Troubleshooting</h1>

<p>See the first tutorial’s
<a href="/OpenGoPro/tutorials/connect-ble#troubleshooting">troubleshooting section</a>.</p>

<h1 id="good-job">Good Job!</h1>

<div class="callout success">
<i class="fa fa-check-circle fa-2x" style="color: #2dcb71; margin: 0.25em;"></i><span>Congratulations 🤙</span>
</div>

<p>You now know how to accumulate TLV responses that are received from the GoPro, at least if they are received uninterrupted.
There is additional logic required for a complete solution such as checking the UUID the response is received
on and storing a dict of response per UUID. At the current time, this endeavor is left for the reader. For a
complete example of this, see the <a href="https://gopro.github.io/OpenGoPro/python_sdk/">Open GoPro Python SDK</a>.</p>

<p>To learn about a different type of operation (Queries), go to the next tutorial.</p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2025-05-14T12:39:49-07:00">May 14, 2025</time></p>

      </footer>

      

      
  <nav class="pagination">
    
      <a href="/OpenGoPro/tutorials/send-ble-commands" class="pagination--pager" title="Tutorial 2: Send BLE TLV Commands
">Previous</a>
    
    
      <a href="/OpenGoPro/tutorials/ble-queries" class="pagination--pager" title="Tutorial 4: BLE TLV Queries
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
<form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div>
</div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
        
        <li><strong>Follow:</strong></li>
           
        <li>
            <a href="https://www.gopro.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i>
                Website</a>
        </li>
          
        <li>
            <a href="https://twitter.com/GoPro" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i>
                Twitter</a>
        </li>
          
        <li>
            <a href="https://www.facebook.com/gopro/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i>
                Facebook</a>
        </li>
          
        <li>
            <a href="https://github.com/gopro" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i>
                GitHub</a>
        </li>
          
        <li>
            <a href="https://www.instagram.com/gopro/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i>
                Instagram</a>
        </li>
           
    </ul>
</div>

<div class="page__footer-copyright">
    © 2025 . Powered by
    <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp;
    <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.
    <p>
        Can be used with GoPro® HERO9 and HERO10 cameras. You must include the following text on
        every page where it can be seen by someone purchasing such an item: <em>"This product
        and/or service is not affiliated with, endorsed by or in any way associated with
        GoPro Inc. or its products and services. GoPro, HERO, and their respective logos
        are trademarks or registered trademarks of GoPro, Inc."</em>
    </p>
</div>

      </footer>
    </div>

    
  <script src="/OpenGoPro/assets/js/main.min.js"></script>




<script src="/OpenGoPro/assets/js/lunr/lunr.min.js"></script>
<script src="/OpenGoPro/assets/js/lunr/lunr-store.js"></script>
<script src="/OpenGoPro/assets/js/lunr/lunr-en.js"></script>






  </body>
</html>
