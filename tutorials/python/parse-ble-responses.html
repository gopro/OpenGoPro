<!DOCTYPE html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
--><html lang="en" class="no-js">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Python Tutorial 3: Parse BLE TLV Responses :  Open GoPro</title>
<meta name="description" content="This document will provide a walk-through tutorial to use bleak to implement the Open GoPro Interface to parse BLE Type-Length-Value (TLV) Responses.">


  <meta name="author" content="GoPro">
  
  <meta property="article:author" content="GoPro">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Open GoPro">
<meta property="og:title" content="Python Tutorial 3: Parse BLE TLV Responses">
<meta property="og:url" content="https://gopro.github.io/OpenGoPro/tutorials/python/parse-ble-responses">


  <meta property="og:description" content="This document will provide a walk-through tutorial to use bleak to implement the Open GoPro Interface to parse BLE Type-Length-Value (TLV) Responses.">







  <meta property="article:published_time" content="2022-07-13T16:09:56-07:00">






<link rel="canonical" href="https://gopro.github.io/OpenGoPro/tutorials/python/parse-ble-responses">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "GoPro",
      "url": "https://gopro.github.io/OpenGoPro/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/OpenGoPro/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>


  
    <script src="/OpenGoPro/assets/js/tabs.js"></script>
  
    <script src="/OpenGoPro/assets/js/quiz.js"></script>
  
    <script src="/OpenGoPro/assets/js/accordion.js"></script>
  


    <link rel="apple-touch-icon" sizes="180x180" href="/OpenGoPro/assets/images/logos/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/OpenGoPro/assets/images/logos/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/OpenGoPro/assets/images/logos/favicon-16x16.png">
<link rel="manifest" href="/OpenGoPro/assets/images/logos/site.webmanifest">
<link rel="mask-icon" href="/OpenGoPro/assets/images/logos/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/OpenGoPro/assets/images/logos/favicon.ico">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="msapplication-config" content="/assets/images/logos/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/OpenGoPro/"><img src="/OpenGoPro/assets/images/logos/logo.png" alt="Open GoPro"></a>
        
        <a class="site-title" href="/OpenGoPro/">
          Open GoPro
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/OpenGoPro/">Home</a>
            </li>
<li class="masthead__menu-item">
              <a href="/OpenGoPro/ble">BLE Specs</a>
            </li>
<li class="masthead__menu-item">
              <a href="/OpenGoPro/http">HTTP Specs</a>
            </li>
<li class="masthead__menu-item">
              <a href="/OpenGoPro/tutorials">Tutorials</a>
            </li>
<li class="masthead__menu-item">
              <a href="/OpenGoPro/demos">Demos</a>
            </li>
<li class="masthead__menu-item">
              <a href="/OpenGoPro/faq">FAQ</a>
            </li>
</ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="https://gopro.github.io/OpenGoPro/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/OpenGoPro/tutorials" itemprop="item"><span itemprop="name">Tutorials</span></a>
          <meta itemprop="position" content="2">
        </li>
        <span class="sep">/</span>
      
    
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/OpenGoPro/python" itemprop="item"><span itemprop="name">Python</span></a>
          <meta itemprop="position" content="3">
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">Python Tutorial 3: Parse BLE TLV Responses</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/OpenGoPro/assets/images/logos/logo_square.png" alt="GoPro" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">GoPro</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Be a <strong>hero</strong>.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">US</span>
        </li>
      

      
        
          
            <li><a href="https://www.gopro.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
          
        
          
            <li><a href="https://twitter.com/GoPro" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.facebook.com/gopro/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i><span class="label">Facebook</span></a></li>
          
        
          
            <li><a href="https://github.com/gopro" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.instagram.com/gopro/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i><span class="label">Instagram</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox">
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <a href="/OpenGoPro/tutorials/python/connect-ble"><span class="nav__sub-title">1: Connect BLE</span></a>
        

        
      </li>
    
      <li>
        
          <a href="/OpenGoPro/tutorials/python/send-ble-commands"><span class="nav__sub-title">2: Send BLE Commands</span></a>
        

        
      </li>
    
      <li>
        
          <a href="/OpenGoPro/tutorials/python/parse-ble-responses"><span class="nav__sub-title">3: Parse BLE TLV Responses</span></a>
        

        
      </li>
    
      <li>
        
          <a href="/OpenGoPro/tutorials/python/ble-queries"><span class="nav__sub-title">4: BLE Queries</span></a>
        

        
      </li>
    
      <li>
        
          <a href="/OpenGoPro/tutorials/python/connect-wifi"><span class="nav__sub-title">5: Connect WiFi</span></a>
        

        
      </li>
    
      <li>
        
          <a href="/OpenGoPro/tutorials/python/send-wifi-commands"><span class="nav__sub-title">6: Send WiFi Commands</span></a>
        

        
      </li>
    
      <li>
        
          <a href="/OpenGoPro/tutorials/python/camera-media-list"><span class="nav__sub-title">7: Camera Media List</span></a>
        

        
      </li>
    
  </ul>
</nav>

    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Python Tutorial 3: Parse BLE TLV Responses">
    <meta itemprop="description" content="This document will provide a walk-through tutorial to use bleak to implementthe Open GoPro Interface to parse BLEType-Length-Value (TLV) Responses.">
    <meta itemprop="datePublished" content="2022-07-13T16:09:56-07:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Python Tutorial 3: Parse BLE TLV Responses
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          12 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
<li><a href="#requirements">Requirements</a></li>
<li><a href="#just-show-me-the-demos">Just Show me the Demo(s)!!</a></li>
<li><a href="#setup">Setup</a></li>
<li><a href="#response-overview">Response Overview</a></li>
<li>
<a href="#parsing-a-one-packet-tlv-response">Parsing a One Packet TLV Response</a><ul>
<li><a href="#command--setting-responses-with-response-length-0">Command / Setting Responses with Response Length 0</a></li>
<li><a href="#complex-command-response">Complex Command Response</a></li>
</ul>
</li>
<li>
<a href="#parsing-multiple-packet-tlv-responses">Parsing Multiple Packet TLV Responses</a><ul>
<li><a href="#accumulating-the-response">Accumulating the Response</a></li>
<li><a href="#query-responses">Query Responses</a></li>
</ul>
</li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#good-job">Good Job!</a></li>
</ul>

            </nav>
          </aside>
        
        <p>This document will provide a walk-through tutorial to use <a href="https://pypi.org/project/bleak/">bleak</a> to implement
the <a href="/OpenGoPro/ble">Open GoPro Interface</a> to parse BLE
<a href="https://en.wikipedia.org/wiki/Type-length-value">Type-Length-Value</a> (TLV) Responses.</p>

<p>Besides TLV, some BLE commands instead return protobuf responses. These will be discussed in a future
tutorial.</p>

<div class="callout warning">
<i class="fa fa-exclamation-triangle fa-2x" style="color: #df5142; margin: 0.25em;"></i><span>It is required that you have first completed the
<a href="/OpenGoPro/tutorials/python/connect-ble#requirements">connect</a>
and <a href="/OpenGoPro/tutorials/python/send-ble-commands">sending commands</a> tutorials before going
through this tutorial.</span>
</div>

<p>This tutorial will give an overview of types of responses, then give examples of parsing each type
before finally providing a <strong>Response</strong> class that will be used in future tutorials.</p>

<h1 id="requirements">Requirements</h1>

<p>It is assumed that the hardware and software requirements from the
<a href="/OpenGoPro/tutorials/python/connect-ble">connect tutorial</a>
are present and configured correctly.</p>

<p>The scripts that will be used for this tutorial can be found in the
<a href="https://github.com/gopro/OpenGoPro/tree/main/demos/python/tutorial/tutorial_modules/tutorial_3_parse_ble_tlv_responses">Tutorial 3 Folder</a>.</p>

<h1 id="just-show-me-the-demos">Just Show me the Demo(s)!!</h1>

<p>Each of the examples described below has a corresponding script to demo it. If you don‚Äôt want to read this
tutorial and just want to see the demo, for example, run:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>python ble_command_get_state.py
</code></pre></div></div>

<div class="callout warning">
<i class="fa fa-exclamation-triangle fa-2x" style="color: #df5142; margin: 0.25em;"></i><span>Python &gt;= 3.8.x must be used as specified in
<a href="/OpenGoPro/tutorials/python/connect-ble#requirements">the requirements</a></span>
</div>

<p>Note that each script has a command-line help which can be found via:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>python ./ble_command_get_state.py <span class="nt">--help</span>
<span class="go">usage: ble_command_get_state.py [-h] [-i IDENTIFIER]

Connect to a GoPro camera via BLE, then get its statuses and settings.

optional arguments:
  -h, --help            show this help message and exit
  -i IDENTIFIER, --identifier IDENTIFIER
                        Last 4 digits of GoPro serial number, which is the last 4 digits of the default camera
                        SSID. If not used, first discovered GoPro will be connected to
</span></code></pre></div></div>

<h1 id="setup">Setup</h1>

<p>We must first connect as was discussed in the
<a href="/OpenGoPro/tutorials/python/connect-ble">connect tutorial</a>. When enabling notifications,
one of the notification handlers described in the following sections will be used.</p>

<h1 id="response-overview">Response Overview</h1>

<p>In the preceding tutorials, we have been using a very simple response handling procedure where the notification
handler simply checks that the UUID is the expected UUID and that the status byte of the response is 0 (Success).
This has been fine since we were only sending specific commands where this works and we know that the sequence
always appears as such (connection sequence left out for brevity):</p>

<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5wYXJ0aWNpcGFudCBQQyBhcyBPcGVuIEdvUHJvIHVzZXIgZGV2aWNlXG5wYXJ0aWNpcGFudCBHb1Byb1xubm90ZSBvdmVyIFBDLCBHb1BybyA6IGRldmljZXMgYXJlIGNvbm5lY3RlZCBhcyBpbiBUdXRvcmlhbCAxXG5QQyAtPj4gR29Qcm86IFdyaXRlIHRvIGNoYXJhY3RlcmlzdGljXG5Hb1BybyAtPj4gUEM6IE5vdGlmaWNhdGlvbiBSZXNwb25zZSAoTVNCID09IDAgKHN0YXJ0KSkiLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9fQ"></p>

<p>In actuality, responses can be more complicated. As described in the
<a href="/OpenGoPro/ble#packet-headers">Open GoPro Interface</a>, responses can be
be comprised of multiple packets where each packet is &lt;= 20 bytes such as:</p>

<p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5wYXJ0aWNpcGFudCBQQyBhcyBPcGVuIEdvUHJvIHVzZXIgZGV2aWNlXG5wYXJ0aWNpcGFudCBHb1Byb1xubm90ZSBvdmVyIFBDLCBHb1BybyA6IGRldmljZXMgYXJlIGNvbm5lY3RlZCBhcyBpbiBUdXRvcmlhbCAxXG5QQyAtPj4gR29Qcm86IFdyaXRlIHRvIGNoYXJhY3RlcmlzdGljXG5Hb1BybyAtPj4gUEM6IE5vdGlmaWNhdGlvbiBSZXNwb25zZSAoTVNCID09IDAgKHN0YXJ0KSlcbkdvUHJvIC0-PiBQQzogTm90aWZpY2F0aW9uIFJlc3BvbnNlIChNU0IgPT0gMSAoY29udGludWF0aW9uKSlcbkdvUHJvIC0-PiBQQzogTm90aWZpY2F0aW9uIFJlc3BvbnNlIChNU0IgPT0gMSAoY29udGludWF0aW9uKSlcbkdvUHJvIC0-PiBQQzogTm90aWZpY2F0aW9uIFJlc3BvbnNlIChNU0IgPT0gMSAoY29udGludWF0aW9uKSkiLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9fQ"></p>

<p>This requires the implementation of accumulating and parsing algorithms which will be described in
[Parsing Multiple Packet TLV Responses].</p>

<h1 id="parsing-a-one-packet-tlv-response">Parsing a One Packet TLV Response</h1>

<p>This section will describe how to parse one packet (&lt;= 20 byte) responses. A one-packet response
is formatted as such:</p>

<table>
  <thead>
    <tr>
      <th>Header (length)</th>
      <th>Command / Setting ID</th>
      <th>Status</th>
      <th>Response</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1 byte</td>
      <td>1 byte</td>
      <td>1 bytes</td>
      <td>Length - 2 bytes</td>
    </tr>
  </tbody>
</table>

<h2 id="command--setting-responses-with-response-length-0">Command / Setting Responses with Response Length 0</h2>

<p>These are the only responses that we have seen thus far through the first 2 tutorials. They
return a status but have a 0 length additional response. For example, consider
<a href="/OpenGoPro/tutorials/python/send-ble-commands#set-shutter">Set Shutter</a>. It returned a response
of:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>02:01:00
</code></pre></div></div>

<p>This equates to:</p>

<table>
  <thead>
    <tr>
      <th>Header (length)</th>
      <th>Command / Setting / Status ID</th>
      <th>Status</th>
      <th>Response</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1 byte</td>
      <td>1 byte</td>
      <td>1 bytes</td>
      <td>Length - 2 bytes</td>
    </tr>
    <tr>
      <td>0x02</td>
      <td>0x01 == Set Shutter</td>
      <td>0x00 == Success</td>
      <td>(2 -2 = 0 bytes)</td>
    </tr>
  </tbody>
</table>

<p>We can see how this response includes the status but no additional response data. This type of
response will be used for most Commands and Setting Responses as seen in the
<a href="/OpenGoPro/tutorials/python/send-ble-commands">previous tutorial</a>.</p>

<h2 id="complex-command-response">Complex Command Response</h2>

<p>There are some commands that do return additional response data. These are called ‚Äúcomplex responses.‚Äù
From the <a href="/OpenGoPro/ble#commands-quick-reference">commands reference</a>, we can see that these are:</p>

<ul>
  <li>Get Open GoPro Version (ID == 0x51)</li>
  <li>Get Hardware Info (ID == 0x3C)</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">ble_command_get_version.py</code> script demonstrates a simple parser for the Open GoPro
Get Version command which we will walk through here.</p>

<div class="callout tip">
<i class="fa fa-tools fa-2x" style="color: #ebc21c; margin: 0.25em;"></i><span>It is important to always query the version after connecting in order to know which API is supported.
See the relevant version of the BLE and / or WiFi spec for more details about each version.</span>
</div>

<p>First, we send the command to the Command Request <a href="/OpenGoPro/ble#services-and-characteristics">UUID</a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">COMMAND_REQ_UUID</span> <span class="o">=</span> <span class="n">GOPRO_BASE_UUID</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">"0072"</span><span class="p">)</span>
<span class="n">event</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
<span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">write_gatt_char</span><span class="p">(</span><span class="n">COMMAND_REQ_UUID</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">]))</span>
<span class="k">await</span> <span class="n">event</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span>  <span class="c1"># Wait to receive the notification response
</span></code></pre></div></div>

<div class="callout note">
<i class="fa fa-clipboard fa-2x" style="color: #3498db; margin: 0.25em;"></i><span>The following snippets of code are taken from the <code class="language-plaintext highlighter-rouge">notification handler</code></span>
</div>

<p>We then receive a response at the expected handle. This is logged as:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">INFO:root:Getting the Getting the Open GoPro version...
INFO:root:Received response at handle=52: b'06:51:00:01:01:01:00'
</span></code></pre></div></div>

<p>This equates to:</p>

<table>
  <thead>
    <tr>
      <th>Header (length)</th>
      <th>Command / Setting / Status ID</th>
      <th>Status</th>
      <th>Response</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1 byte</td>
      <td>1 byte</td>
      <td>1 bytes</td>
      <td>Length - 2 bytes</td>
    </tr>
    <tr>
      <td>0x06</td>
      <td>0x51 == Get Version</td>
      <td>0x00 == Success</td>
      <td>0x01 0x01 0x01 0x00</td>
    </tr>
  </tbody>
</table>

<p>We can see that this ‚Äúcomplex response‚Äù contains 4 additional bytes that need to be parsed. Using the information
from the <a href="/OpenGoPro/ble#complex-command-responses">interface description</a>,
we know to parse this as:</p>

<table>
  <thead>
    <tr>
      <th>Byte</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x01</td>
      <td>Length of Major Version Number</td>
    </tr>
    <tr>
      <td>0x01</td>
      <td>Major Version Number</td>
    </tr>
    <tr>
      <td>0x01</td>
      <td>Length of Minor Version Number</td>
    </tr>
    <tr>
      <td>0x00</td>
      <td>Minor Version Number</td>
    </tr>
  </tbody>
</table>

<p>We implement this in the notification handler as follows. First, we parse the length, command ID, and status
from the first 3 bytes of the response:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">len</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">command_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</code></pre></div></div>

<p>Next we parse the remaining four bytes of the response as individual values formatted as such:</p>

<table>
  <thead>
    <tr>
      <th>Length</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1 byte</td>
      <td>Length bytes</td>
    </tr>
  </tbody>
</table>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">index</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">while</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">:</span>
    <span class="n">param_len</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">params</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">index</span> <span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="n">param_len</span><span class="p">])</span>
    <span class="n">index</span> <span class="o">+=</span> <span class="n">param_len</span>
</code></pre></div></div>

<p>From the complex response definition, we know these parameters equate to the major and the minor version so
let‚Äôs print them (and all of the other response information) as such:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">major</span><span class="p">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">params</span>
<span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"Received a response to </span><span class="si">{</span><span class="n">command_id</span><span class="o">=</span><span class="si">}</span><span class="s"> with </span><span class="si">{</span><span class="n">status</span><span class="o">=</span><span class="si">}</span><span class="s">: version=</span><span class="si">{</span><span class="n">major</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">.</span><span class="si">{</span><span class="n">minor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>which shows on the log as:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">INFO:root:Received a response to command_id=81 with status=0: version=1.0
</span></code></pre></div></div>

<p><strong>Quiz time! üìö ‚úèÔ∏è</strong></p>

<div id="quiz_b29cd5a7-0b68-4bed-8ffc-41caf67f1ea3" class="quiz">
    <div>
        <div id="question_b29cd5a7-0b68-4bed-8ffc-41caf67f1ea3" class="quiz__question">What is the maximum size of an individual notification response packet?</div>
        <div id="answers_b29cd5a7-0b68-4bed-8ffc-41caf67f1ea3">
        
            <input type="radio" name="question" value="A"><label>A: 20 bytes</label>
            <br>
        
            <input type="radio" name="question" value="B"><label>B: 256 bytes</label>
            <br>
        
            <input type="radio" name="question" value="C"><label>C: There is no maximum size</label>
            <br>
        
        </div>
    </div>
    <button onclick="showResults('b29cd5a7-0b68-4bed-8ffc-41caf67f1ea3', 'A')">Submit Answer</button>
    <div id="results_b29cd5a7-0b68-4bed-8ffc-41caf67f1ea3" style="display: none">
        <span id="correct_b29cd5a7-0b68-4bed-8ffc-41caf67f1ea3" style="display: none">  Correct!! üòÉ</span>
        <span id="incorrect_b29cd5a7-0b68-4bed-8ffc-41caf67f1ea3" style="display: none"> Incorrect!! üò≠ The correct answer is A.</span>
        Responses can be composed of multiple packets where each packet is at
    maximum 20 bytes.
    </div>
</div>

<div id="quiz_c2955546-a45f-4d1d-8071-1d7bc390fe44" class="quiz">
    <div>
        <div id="question_c2955546-a45f-4d1d-8071-1d7bc390fe44" class="quiz__question">What is the maximum amount of packets that one response can be composed of?</div>
        <div id="answers_c2955546-a45f-4d1d-8071-1d7bc390fe44">
        
            <input type="radio" name="question" value="A"><label>A: 20 bytes</label>
            <br>
        
            <input type="radio" name="question" value="B"><label>B: 256 bytes</label>
            <br>
        
            <input type="radio" name="question" value="C"><label>C: There is no maximum size</label>
            <br>
        
        </div>
    </div>
    <button onclick="showResults('c2955546-a45f-4d1d-8071-1d7bc390fe44', 'C')">Submit Answer</button>
    <div id="results_c2955546-a45f-4d1d-8071-1d7bc390fe44" style="display: none">
        <span id="correct_c2955546-a45f-4d1d-8071-1d7bc390fe44" style="display: none">  Correct!! üòÉ</span>
        <span id="incorrect_c2955546-a45f-4d1d-8071-1d7bc390fe44" style="display: none"> Incorrect!! üò≠ The correct answer is C.</span>
        There is no limit on the amount of packets that can comprise a response.
    </div>
</div>

<div id="quiz_9f040bff-b0a6-4f10-bb48-84449ac9be76" class="quiz">
    <div>
        <div id="question_9f040bff-b0a6-4f10-bb48-84449ac9be76" class="quiz__question">What is the maximum amount of packets that one response can be composed of?</div>
        <div id="answers_9f040bff-b0a6-4f10-bb48-84449ac9be76">
        
            <input type="radio" name="question" value="A"><label>A: Always 1 packet</label>
            <br>
        
            <input type="radio" name="question" value="B"><label>B: Always multiple packets.</label>
            <br>
        
            <input type="radio" name="question" value="C"><label>C: Always 1 packet except for complex responses.</label>
            <br>
        
        </div>
    </div>
    <button onclick="showResults('9f040bff-b0a6-4f10-bb48-84449ac9be76', 'C')">Submit Answer</button>
    <div id="results_9f040bff-b0a6-4f10-bb48-84449ac9be76" style="display: none">
        <span id="correct_9f040bff-b0a6-4f10-bb48-84449ac9be76" style="display: none">  Correct!! üòÉ</span>
        <span id="incorrect_9f040bff-b0a6-4f10-bb48-84449ac9be76" style="display: none"> Incorrect!! üò≠ The correct answer is C.</span>
        Command responses are almost always 1 packet (just returning the status).
    The exception are complex responses which can be multiple packets (in the case of Get Hardware
    Info)
    </div>
</div>

<div id="quiz_83ba732d-400b-484c-ad11-d6a27351efbe" class="quiz">
    <div>
        <div id="question_83ba732d-400b-484c-ad11-d6a27351efbe" class="quiz__question">How many packets are setting responses comprised of?</div>
        <div id="answers_83ba732d-400b-484c-ad11-d6a27351efbe">
        
            <input type="radio" name="question" value="A"><label>A: Always 1 packet</label>
            <br>
        
            <input type="radio" name="question" value="B"><label>B: Always multiple packets.</label>
            <br>
        
            <input type="radio" name="question" value="C"><label>C: Always 1 packet except for complex responses.</label>
            <br>
        
        </div>
    </div>
    <button onclick="showResults('83ba732d-400b-484c-ad11-d6a27351efbe', 'A')">Submit Answer</button>
    <div id="results_83ba732d-400b-484c-ad11-d6a27351efbe" style="display: none">
        <span id="correct_83ba732d-400b-484c-ad11-d6a27351efbe" style="display: none">  Correct!! üòÉ</span>
        <span id="incorrect_83ba732d-400b-484c-ad11-d6a27351efbe" style="display: none"> Incorrect!! üò≠ The correct answer is A.</span>
        Settings Responses only ever contain the command status. Furthermore, there
    is no concept of complex responses for setting commands.
    </div>
</div>

<h1 id="parsing-multiple-packet-tlv-responses">Parsing Multiple Packet TLV Responses</h1>

<p>This section will describe parsing TLV responses that contain more than one packet. It will first describe how
to accumulate such responses and then provide a parsing example. The example script that will be walked through
for this section is <code class="language-plaintext highlighter-rouge">ble_command_get_state.py</code>. We will be creating a small <em>Response</em> class that will be
re-used for future tutorials.</p>

<h2 id="accumulating-the-response">Accumulating the Response</h2>

<p>The first step is to accumulate the multiple packets into one response. Whereas for all tutorials until now, we
have just used the header bytes of the response as the length, we now must completely parse the header as it is
defined:</p>

<table border="1">
  <tbody>
    <tr>
        <td colspan="8">Byte 1</td>
        <td colspan="8">Byte 2 (optional)</td>
        <td colspan="8">Byte 3 (optional)</td>
    </tr>
    <tr>
        <td>7</td>
        <td>6</td>
        <td>5</td>
        <td>4</td>
        <td>3</td>
        <td>2</td>
        <td>1</td>
        <td>0</td>
        <td>7</td>
        <td>6</td>
        <td>5</td>
        <td>4</td>
        <td>3</td>
        <td>2</td>
        <td>1</td>
        <td>0</td>
        <td>7</td>
        <td>6</td>
        <td>5</td>
        <td>4</td>
        <td>3</td>
        <td>2</td>
        <td>1</td>
        <td>0</td>
    </tr>
    <tr>
        <td>0: Start</td>
        <td colspan="2">00: General</td>
        <td colspan="5">Message Length: 5 bits</td>
        <td colspan="16">
</td>
    </tr>
    <tr>
        <td>0: Start</td>
        <td colspan="2">01: Extended (13-bit)</td>
        <td colspan="13">Message Length: 13 bits</td>
        <td colspan="8">
</td>
    </tr>
    <tr>
        <td>0: Start</td>
        <td colspan="2">10: Extended (16-bit)</td>
        <td colspan="5">
</td>
        <td colspan="16">Message Length: 16 bits</td>
    </tr>
    <tr>
        <td>0: Start</td>
        <td colspan="2">11: Reserved</td>
        <td colspan="21">
</td>
    </tr>
    <tr>
        <td>1: Continuation</td>
        <td colspan="24">
</td>
    </tr>
  </tbody>
</table>

<p>The basic algorithm here (which is implemented in the <em>Message.accumulate</em> method) is as follows:</p>

<hr>

<div class="md_column">
<div>
    <p>Continuation bit set?</p>

    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CONT_MASK</span><span class="p">:</span>
    <span class="n">buf</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="p">...</span>
</code></pre></div>    </div>

    <p>No, continuation bit was not set. So create new response, then get its length.</p>

    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># This is a new packet so start with an empty byte array
</span><span class="bp">self</span><span class="p">.</span><span class="nb">bytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
<span class="n">hdr</span> <span class="o">=</span> <span class="n">Header</span><span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HDR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span>
<span class="k">if</span> <span class="n">hdr</span> <span class="ow">is</span> <span class="n">Header</span><span class="p">.</span><span class="n">GENERAL</span><span class="p">:</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">bytes_remaining</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">GEN_LEN_MASK</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="k">elif</span> <span class="n">hdr</span> <span class="ow">is</span> <span class="n">Header</span><span class="p">.</span><span class="n">EXT_13</span><span class="p">:</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">bytes_remaining</span> <span class="o">=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">EXT_13_BYTE0_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="k">elif</span> <span class="n">hdr</span> <span class="ow">is</span> <span class="n">Header</span><span class="p">.</span><span class="n">EXT_16</span><span class="p">:</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">bytes_remaining</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
</code></pre></div>    </div>

    <p>Append current packet to response and decrement bytes remaining.</p>

    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># Append payload to buffer and update remaining / complete
</span><span class="bp">self</span><span class="p">.</span><span class="nb">bytes</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="bp">self</span><span class="p">.</span><span class="n">bytes_remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>In the notification handler, we are then parsing if there are no bytes remaining.</p>

    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">is_received</span><span class="p">:</span>
        <span class="n">response</span><span class="p">.</span><span class="n">parse</span><span class="p">()</span>
</code></pre></div>    </div>

  </div>

<div style="60%">
    <p><br><br><br>
<img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoiZ3JhcGggVERcbkFbUmVhZCBBdmFpbGFibGUgUGFja2V0XSAtLT4gQ3tDb250aW51YXRpb24gYml0IHNldD99XG5DIC0tPnxOb3wgRFtDcmVhdGUgbmV3IGVtcHR5IHJlc3BvbnNlXVxuRCAtLT4gSVtHZXQgYnl0ZXMgcmVtYWluaW5nLCBpLmUuIGxlbmd0aF1cbkkgLS0-IEVcbkMgLS0-fFllc3wgRVtBcHBlbmQgcGFja2V0IHRvIGFjY3VtdWxhdGluZyByZXNwb25zZV1cbkUgLS0-IHxEZWNyZW1lbnQgYnl0ZXMgcmVtYWluaW5nfCBGe0J5dGVzIHJlbWFpbmluZyA9PSAwP31cbkYgLS0-fFllc3wgR1tQYXJzZSBSZWNlaXZlZCBQYWNrZXRdXG5GIC0tPnxOb3wgQSIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In19"></p>
  </div>
</div>

<hr>

<p>We can see this in action when we send the <em>Get All Setting Values</em> Query.</p>

<div class="callout note">
<i class="fa fa-clipboard fa-2x" style="color: #3498db; margin: 0.25em;"></i><span>Queries aren‚Äôt introduced until the next tutorial so for now, just pay attention to the response.</span>
</div>

<p>We send the command as such:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QUERY_REQ_UUID</span> <span class="o">=</span> <span class="n">GOPRO_BASE_UUID</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">"0076"</span><span class="p">)</span>
<span class="n">event</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
<span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">write_gatt_char</span><span class="p">(</span><span class="n">QUERY_REQ_UUID</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">([</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">]))</span>
<span class="k">await</span> <span class="n">event</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span>  <span class="c1"># Wait to receive the notification response
</span></code></pre></div></div>

<p>Then, in the notification handler, we continuously receive and accumulate packets until we have
received the entire response, at which point we notify the writer that the response is ready:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">def</span> <span class="nf">notification_handler</span><span class="p">(</span><span class="n">handle</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">response</span><span class="p">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">is_received</span><span class="p">:</span>
            <span class="n">response</span><span class="p">.</span><span class="n">parse</span><span class="p">()</span>

            <span class="c1"># Notify writer that procedure is complete
</span>            <span class="n">event</span><span class="p">.</span><span class="nb">set</span><span class="p">()</span>
</code></pre></div></div>

<div class="callout note">
<i class="fa fa-clipboard fa-2x" style="color: #3498db; margin: 0.25em;"></i><span>We also first parse the response but that will be described in the next section.</span>
</div>

<p>We can see the individual packets being accumulated in the log:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">INFO:root:Getting the camera's settings...
INFO:root:Received response at handle=62: b'21:25:12:00:02:01:09:03:01:01:05:0
INFO:root:self.bytes_remaining=275
INFO:root:Received response at handle=62: b'80:01:00:18:01:00:1e:04:00:00:00:0
INFO:root:self.bytes_remaining=256
INFO:root:Received response at handle=62: b'81:0a:25:01:00:29:01:09:2a:01:05:2
INFO:root:self.bytes_remaining=237
INFO:root:Received response at handle=62: b'82:2f:01:04:30:01:03:36:01:00:3b:0
INFO:root:self.bytes_remaining=218
INFO:root:Received response at handle=62: b'83:04:00:00:00:00:3e:04:00:00:00:0
INFO:root:self.bytes_remaining=199
INFO:root:Received response at handle=62: b'84:00:42:04:00:00:00:00:43:04:00:0
INFO:root:self.bytes_remaining=180
INFO:root:Received response at handle=62: b'85:4f:01:00:53:01:00:54:01:00:55:0
INFO:root:self.bytes_remaining=161
INFO:root:Received response at handle=62: b'86:01:28:5b:01:02:60:01:00:66:01:0
INFO:root:self.bytes_remaining=142
INFO:root:Received response at handle=62: b'87:00:6a:01:00:6f:01:0a:70:01:ff:7
INFO:root:self.bytes_remaining=123
INFO:root:Received response at handle=62: b'88:75:01:00:76:01:04:79:01:00:7a:0
INFO:root:self.bytes_remaining=104
INFO:root:Received response at handle=62: b'89:01:00:7e:01:00:80:01:0c:81:01:0
INFO:root:self.bytes_remaining=85
INFO:root:Received response at handle=62: b'8a:0c:85:01:09:86:01:00:87:01:01:8
INFO:root:self.bytes_remaining=66
INFO:root:Received response at handle=62: b'8b:92:01:00:93:01:00:94:01:02:95:0
INFO:root:self.bytes_remaining=47
INFO:root:Received response at handle=62: b'8c:01:00:9c:01:00:9d:01:00:9e:01:0
INFO:root:self.bytes_remaining=28
INFO:root:Received response at handle=62: b'8d:00:a2:01:00:a3:01:01:a4:01:00:a
INFO:root:self.bytes_remaining=9
INFO:root:Received response at handle=62: b'8e:a8:04:00:00:00:00:a9:01:01'
INFO:root:self.bytes_remaining=0
INFO:root:Successfully received the response
</span></code></pre></div></div>

<p>At this point the response has been accumulated. See the next section for how to parse it.</p>

<p><strong>Quiz time! üìö ‚úèÔ∏è</strong></p>

<div id="quiz_0b5afa2f-aaf4-4de5-a2f9-3a95488503a5" class="quiz">
    <div>
        <div id="question_0b5afa2f-aaf4-4de5-a2f9-3a95488503a5" class="quiz__question">How can we know that a response has been completely received?</div>
        <div id="answers_0b5afa2f-aaf4-4de5-a2f9-3a95488503a5">
        
            <input type="radio" name="question" value="A"><label>A: The stop bit will be set in the header</label>
            <br>
        
            <input type="radio" name="question" value="B"><label>B: The response has accumulated length bytes</label>
            <br>
        
            <input type="radio" name="question" value="C"><label>C: By checking for the end of frame (EOF) sentinel character</label>
            <br>
        
        </div>
    </div>
    <button onclick="showResults('0b5afa2f-aaf4-4de5-a2f9-3a95488503a5', 'B')">Submit Answer</button>
    <div id="results_0b5afa2f-aaf4-4de5-a2f9-3a95488503a5" style="display: none">
        <span id="correct_0b5afa2f-aaf4-4de5-a2f9-3a95488503a5" style="display: none">  Correct!! üòÉ</span>
        <span id="incorrect_0b5afa2f-aaf4-4de5-a2f9-3a95488503a5" style="display: none"> Incorrect!! üò≠ The correct answer is B.</span>
        The length of the entire response is parsed from the first packet. We
        then accumulate packets, keeping track of the received length, until all of the bytes
        have been received. A and C are just made up üòú.
    </div>
</div>

<h2 id="query-responses">Query Responses</h2>

<p>This section is going to describe responses to to BLE status / setting queries. We don‚Äôt actually
introduce such queries until <a href="/OpenGoPro/tutorials/python/ble-queries">the next tutorial</a> so
for now, only the parsing of the response is important.</p>

<div class="callout tip">
<i class="fa fa-tools fa-2x" style="color: #ebc21c; margin: 0.25em;"></i><span>While multi-packet responses are almost always Query Responses, they can also be from Command Complex <br>
responses. In a real-world implementation, it is therefore necessary to check the received UUID to see
how to parse.</span>
</div>

<p>Query Responses contain one or more TLV groups in their Response data. To recap, the generic response format is:</p>

<table>
  <thead>
    <tr>
      <th>Header (length)</th>
      <th>Query ID</th>
      <th>Status</th>
      <th>Response</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1-2 bytes</td>
      <td>1 byte</td>
      <td>1 bytes</td>
      <td>Length - 2 bytes</td>
    </tr>
  </tbody>
</table>

<p>This means that query responses will contain an array of additional TLV groups in the ‚ÄúResponse‚Äù field as such:</p>

<table>
  <thead>
    <tr>
      <th>ID1</th>
      <th>Length1</th>
      <th>Value1</th>
      <th>ID2</th>
      <th>Length2</th>
      <th>Value 2</th>
      <th>‚Ä¶</th>
      <th>IDN</th>
      <th>LengthN</th>
      <th>ValueN</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1 byte</td>
      <td>1 byte</td>
      <td>Length1 bytes</td>
      <td>1 byte</td>
      <td>1 byte</td>
      <td>Length2 bytes</td>
      <td>‚Ä¶</td>
      <td>1 byte</td>
      <td>1 byte</td>
      <td>LengthN bytes</td>
    </tr>
  </tbody>
</table>

<p>Depending on the amount of query results in the response, this response can be one or multiple packets.
Therefore, we need to account for the possibility that it may always be more than 1 packet.</p>

<p>We can see an example of such parsing in the <strong>Response.parse</strong> method:</p>

<hr>

<div class="md_column">
<div>

    <p>We have already parsed the length when we were accumulating the packet. So the next step is to parse the Query
ID and Status:</p>

    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="bp">self</span><span class="p">.</span><span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="bp">self</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>    </div>

    <p>We then continuously parse <strong>Type (ID) - Length - Value</strong> groups until we have consumed the response. We are
storing each value in a dict indexed by ID for later access.</p>

    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Get ID and Length
</span>    <span class="n">param_id</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">param_len</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="c1"># Get the value
</span>    <span class="n">value</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">param_len</span><span class="p">]</span>

    <span class="c1"># Store in dict for later access
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">param_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># Advance the buffer
</span>    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">param_len</span><span class="p">:]</span>
</code></pre></div>    </div>

  </div>
<div style="flex:60%">

    <p><br><br><br></p>

    <p><img class="mermaid" src="https://mermaid.ink/svg/eyJjb2RlIjoiZ3JhcGggVERcbkFbUGFyc2UgUXVlcnkgSURdIC0tPiBCW1BhcnNlIFN0YXR1c11cbkIgLS0-IEN7TW9yZSBkYXRhP31cbkMgLS0-IHx5ZXN8RFtHZXQgVmFsdWUgSURdXG5EIC0tPiBFW0dldCBWYWx1ZSBMZW5ndGhdXG5FIC0tPiBGW0dldCBWYWx1ZV1cbkYgLS0-IENcbkMgLS0-IHxub3xHKGRvbmUpIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifX0"></p>

  </div>
</div>

<hr>

<p>In the demo, we then log this entire dict after parsing is complete as such (abbreviated for brevity):</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">INFO:root:Received settings
: {
    "2": "09",
    "3": "01",
    "5": "00",
    "6": "01",
    "13": "01",
    "19": "00",
    "30": "00:00:00:00",
    "31": "00",
    "32": "00:00:00:0a",
    "41": "09",
    "42": "05",
    "43": "00",
</span><span class="c">    ...
</span><span class="go">    "153": "00",
    "154": "01",
    "155": "00",
    "156": "00",
    "157": "00",
    "158": "01",
    "159": "00",
    "160": "00",
    "161": "00",
    "162": "00",
    "163": "01",
    "164": "00",
    "165": "00",
    "166": "00",
    "167": "04",
    "168": "00:00:00:00",
    "169": "01"
}
</span></code></pre></div></div>

<p>We can see what each of these values mean by looking at the
<a href="/OpenGoPro/ble#settings-quick-reference">Open GoPro Interface</a>.</p>

<p>For example:</p>

<ul>
  <li>ID 2 == 9 equates to Resolution == 1080</li>
  <li>ID 3 == 1 equates to FPS == 120</li>
</ul>

<div id="quiz_50cef5c8-8f15-4e67-9bfe-5ed7bd287e58" class="quiz">
    <div>
        <div id="question_50cef5c8-8f15-4e67-9bfe-5ed7bd287e58" class="quiz__question">How many packets are query responses?</div>
        <div id="answers_50cef5c8-8f15-4e67-9bfe-5ed7bd287e58">
        
            <input type="radio" name="question" value="A"><label>A: Always 1 packet</label>
            <br>
        
            <input type="radio" name="question" value="B"><label>B: Always multiple packets</label>
            <br>
        
            <input type="radio" name="question" value="C"><label>C: Always 1 packet except for complex responses</label>
            <br>
        
            <input type="radio" name="question" value="D"><label>D: Can be 1 or multiple packets</label>
            <br>
        
        </div>
    </div>
    <button onclick="showResults('50cef5c8-8f15-4e67-9bfe-5ed7bd287e58', 'D')">Submit Answer</button>
    <div id="results_50cef5c8-8f15-4e67-9bfe-5ed7bd287e58" style="display: none">
        <span id="correct_50cef5c8-8f15-4e67-9bfe-5ed7bd287e58" style="display: none">  Correct!! üòÉ</span>
        <span id="incorrect_50cef5c8-8f15-4e67-9bfe-5ed7bd287e58" style="display: none"> Incorrect!! üò≠ The correct answer is D.</span>
        Query responses can be one packet (if for example querying a specific
setting) or multiple packets (when querying many or all settings as in the example here).
See the next tutorial for more information on queries.
    </div>
</div>

<div id="quiz_2bd4ec88-f550-4067-93f8-637c4d9ed6bf" class="quiz">
    <div>
        <div id="question_2bd4ec88-f550-4067-93f8-637c4d9ed6bf" class="quiz__question">Which field is not common to all responses?</div>
        <div id="answers_2bd4ec88-f550-4067-93f8-637c4d9ed6bf">
        
            <input type="radio" name="question" value="A"><label>A: length</label>
            <br>
        
            <input type="radio" name="question" value="B"><label>B: status</label>
            <br>
        
            <input type="radio" name="question" value="C"><label>C: ID</label>
            <br>
        
        </div>
    </div>
    <button onclick="showResults('2bd4ec88-f550-4067-93f8-637c4d9ed6bf', 'D')">Submit Answer</button>
    <div id="results_2bd4ec88-f550-4067-93f8-637c4d9ed6bf" style="display: none">
        <span id="correct_2bd4ec88-f550-4067-93f8-637c4d9ed6bf" style="display: none">  Correct!! üòÉ</span>
        <span id="incorrect_2bd4ec88-f550-4067-93f8-637c4d9ed6bf" style="display: none"> Incorrect!! üò≠ The correct answer is D.</span>
        Query responses can be one packet (if for example querying a specific
setting) or multiple packets (when querying many or all settings as in the example here).
See the next tutorial for more information on queries.
    </div>
</div>

<h1 id="troubleshooting">Troubleshooting</h1>

<p>See the first tutorial‚Äôs
<a href="/OpenGoPro/tutorials/python/connect-ble#troubleshooting">troubleshooting section</a>.</p>

<h1 id="good-job">Good Job!</h1>

<div class="callout success">
<i class="fa fa-check-circle fa-2x" style="color: #2dcb71; margin: 0.25em;"></i><span>Congratulations ü§ô</span>
</div>

<p>You can now parse any TLV response that is received from the GoPro, at least if it is received uninterrupted.
There is additional logic required for a complete solution such as checking the UUID the response is received
on and storing a dict of response per UUID. At the current time, this endeavor is left for the reader. For a
complete example of this, see the <a href="https://gopro.github.io/OpenGoPro/python_sdk/">Open GoPro Python SDK</a>.</p>

<p>To learn more about queries, go to the next tutorial.</p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2022-07-13T16:09:56-07:00">July 13, 2022</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/OpenGoPro/tutorials/python/send-ble-commands" class="pagination--pager" title="Python Tutorial 2: Send BLE Commands
">Previous</a>
    
    
      <a href="/OpenGoPro/tutorials/python/ble-queries" class="pagination--pager" title="Python Tutorial 4: BLE Queries
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
<form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div>
</div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
           
        <li>
            <a href="https://www.gopro.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i>
                Website</a>
        </li>
          
        <li>
            <a href="https://twitter.com/GoPro" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i>
                Twitter</a>
        </li>
          
        <li>
            <a href="https://www.facebook.com/gopro/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i>
                Facebook</a>
        </li>
          
        <li>
            <a href="https://github.com/gopro" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i>
                GitHub</a>
        </li>
          
        <li>
            <a href="https://www.instagram.com/gopro/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i>
                Instagram</a>
        </li>
           
    </ul>
</div>

<div class="page__footer-copyright">
    ¬© 2022 GoPro. Powered by
    <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp;
    <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.
    <p>
        Can be used with GoPro¬Æ HERO9 and HERO10 cameras. You must include the following text on
        every page where it can be seen by someone purchasing such an item: <em>"This product
        and/or service is not affiliated with, endorsed by or in any way associated with
        GoPro Inc. or its products and services. GoPro, HERO, and their respective logos
        are trademarks or registered trademarks of GoPro, Inc."</em>
    </p>
</div>

      </footer>
    </div>

    
  <script src="/OpenGoPro/assets/js/main.min.js"></script>




<script src="/OpenGoPro/assets/js/lunr/lunr.min.js"></script>
<script src="/OpenGoPro/assets/js/lunr/lunr-store.js"></script>
<script src="/OpenGoPro/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
